<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>Consul - 标签 - 楚兴 - Chuxing's Blog</title><link>https://xzygis.github.io/tags/consul/</link><description>Consul - 标签 - 楚兴 - Chuxing's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>xzygis@163.com (chuxing)</managingEditor><webMaster>xzygis@163.com (chuxing)</webMaster><lastBuildDate>Thu, 30 Jan 2020 13:35:59 +0000</lastBuildDate><atom:link href="https://xzygis.github.io/tags/consul/" rel="self" type="application/rss+xml"/><item><title>Consul入门手册</title><link>https://xzygis.github.io/posts/manual-of-consul/</link><pubDate>Thu, 30 Jan 2020 13:35:59 +0000</pubDate><author>chuxing</author><guid>https://xzygis.github.io/posts/manual-of-consul/</guid><description><![CDATA[<h2 id="consul是什么">Consul是什么？</h2>
<p>Consul是一个服务发现和配置工具，它是分布式和高可用的，而且极易扩展。</p>
<p>Consul主要提供了以下特性：</p>
<ol>
<li>服务发现：Consul使得服务注册和服务发现（通过DNS或HTTP接口）变得非常简单。</li>
<li>健康检查：健康检查使得Consul可以快速向管理员报告集群状况。将它与服务发现集成，可以防止流量路由到故障节点，实现服务熔断。</li>
<li>KV存储：灵活的KV存储，可用于尺寸出动态配置、功能特性、协调信息和选举信息等。简单的HTTP API使其易于在任何地方地方。</li>
<li>多数据中心：Consul支持多数据中心，不需要负责的配置就可以支持任意数量的数据中心。</li>
<li>服务鉴权（Service Segmentation）：Consul连接基于自动TLS加密和基于签名的鉴权实现安全的服务间通信。</li>
</ol>
<p>Consul支持Linux, Mac OS X, FreeBSD, Solaris, Windows等操作系统。</p>
<h3 id="基本架构">基本架构</h3>
<p>每个提供服务给Consul的节点都运行了一个Consul Agent。运行一个Agent并不需要对其他服务做发现或读写KV存储。Agent负责对该节点上的服务做健康检查。</p>
<p>Agent会与一个或多个Consul Server通信。Consul Server通常有多个实例，负责数据存储和备份、选举主节点等。虽然Consul支持在只有一个Server实例的情况下工具，但通常推荐使用3至5个实例，从而避免由于某些异常场景而导致数据丢失。同时，推荐在每个数据中心部署一个Consul集群。</p>
<p>每个数据中运行了一个Consul server集群。当一个跨数据中心的服务发现和配置请求创建时，本地Consul Server转发请求到远程的数据中心并返回结果.</p>
<h2 id="安装consul">安装Consul</h2>
<p>Consul集群的每个节点都必须先安装Consul，安装非常简单。在Mac上安装Consul命令如下：</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ brew install consul</span></span></code></pre></td></tr></table>
</div>
</div><p>安装成功后执行consul命令输出如下结果：</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">$</span> <span class="n">consul</span>
</span></span><span class="line"><span class="cl"><span class="n">Usage</span><span class="p">:</span> <span class="n">consul</span> <span class="p">[</span><span class="o">--</span><span class="n">version</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">help</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">command</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">args</span><span class="o">&gt;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Available</span> <span class="n">commands</span> <span class="n">are</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">acl</span>            <span class="n">Interact</span> <span class="n">with</span> <span class="n">Consul</span><span class="s1">&#39;s ACLs</span>
</span></span><span class="line"><span class="cl">    <span class="n">agent</span>          <span class="n">Runs</span> <span class="n">a</span> <span class="n">Consul</span> <span class="n">agent</span>
</span></span><span class="line"><span class="cl">    <span class="n">catalog</span>        <span class="n">Interact</span> <span class="n">with</span> <span class="n">the</span> <span class="n">catalog</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span>         <span class="n">Interact</span> <span class="n">with</span> <span class="n">Consul</span><span class="s1">&#39;s Centralized Configurations</span>
</span></span><span class="line"><span class="cl">    <span class="n">connect</span>        <span class="n">Interact</span> <span class="n">with</span> <span class="n">Consul</span> <span class="n">Connect</span>
</span></span><span class="line"><span class="cl">    <span class="n">debug</span>          <span class="n">Records</span> <span class="n">a</span> <span class="n">debugging</span> <span class="n">archive</span> <span class="k">for</span> <span class="n">operators</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span>          <span class="n">Fire</span> <span class="n">a</span> <span class="n">new</span> <span class="n">event</span>
</span></span><span class="line"><span class="cl">    <span class="n">exec</span>           <span class="n">Executes</span> <span class="n">a</span> <span class="n">command</span> <span class="n">on</span> <span class="n">Consul</span> <span class="n">nodes</span>
</span></span><span class="line"><span class="cl">    <span class="n">force</span><span class="o">-</span><span class="n">leave</span>    <span class="n">Forces</span> <span class="n">a</span> <span class="n">member</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cluster</span> <span class="n">to</span> <span class="n">enter</span> <span class="n">the</span> <span class="s2">&#34;left&#34;</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span>           <span class="n">Provides</span> <span class="n">debugging</span> <span class="n">information</span> <span class="k">for</span> <span class="n">operators</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="n">intention</span>      <span class="n">Interact</span> <span class="n">with</span> <span class="n">Connect</span> <span class="n">service</span> <span class="n">intentions</span>
</span></span><span class="line"><span class="cl">    <span class="n">join</span>           <span class="n">Tell</span> <span class="n">Consul</span> <span class="n">agent</span> <span class="n">to</span> <span class="n">join</span> <span class="n">cluster</span>
</span></span><span class="line"><span class="cl">    <span class="n">keygen</span>         <span class="n">Generates</span> <span class="n">a</span> <span class="n">new</span> <span class="n">encryption</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">    <span class="n">keyring</span>        <span class="n">Manages</span> <span class="n">gossip</span> <span class="n">layer</span> <span class="n">encryption</span> <span class="n">keys</span>
</span></span><span class="line"><span class="cl">    <span class="n">kv</span>             <span class="n">Interact</span> <span class="n">with</span> <span class="n">the</span> <span class="n">key</span><span class="o">-</span><span class="n">value</span> <span class="n">store</span>
</span></span><span class="line"><span class="cl">    <span class="n">leave</span>          <span class="n">Gracefully</span> <span class="n">leaves</span> <span class="n">the</span> <span class="n">Consul</span> <span class="n">cluster</span> <span class="ow">and</span> <span class="n">shuts</span> <span class="n">down</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span>           <span class="n">Execute</span> <span class="n">a</span> <span class="n">command</span> <span class="n">holding</span> <span class="n">a</span> <span class="n">lock</span>
</span></span><span class="line"><span class="cl">    <span class="n">login</span>          <span class="n">Login</span> <span class="n">to</span> <span class="n">Consul</span> <span class="n">using</span> <span class="n">an</span> <span class="n">auth</span> <span class="n">method</span>
</span></span><span class="line"><span class="cl">    <span class="n">logout</span>         <span class="n">Destroy</span> <span class="n">a</span> <span class="n">Consul</span> <span class="n">token</span> <span class="n">created</span> <span class="n">with</span> <span class="n">login</span>
</span></span><span class="line"><span class="cl">    <span class="n">maint</span>          <span class="n">Controls</span> <span class="n">node</span> <span class="ow">or</span> <span class="n">service</span> <span class="n">maintenance</span> <span class="n">mode</span>
</span></span><span class="line"><span class="cl">    <span class="n">members</span>        <span class="n">Lists</span> <span class="n">the</span> <span class="n">members</span> <span class="n">of</span> <span class="n">a</span> <span class="n">Consul</span> <span class="n">cluster</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span>        <span class="n">Stream</span> <span class="n">logs</span> <span class="n">from</span> <span class="n">a</span> <span class="n">Consul</span> <span class="n">agent</span>
</span></span><span class="line"><span class="cl">    <span class="n">operator</span>       <span class="n">Provides</span> <span class="n">cluster</span><span class="o">-</span><span class="n">level</span> <span class="n">tools</span> <span class="k">for</span> <span class="n">Consul</span> <span class="n">operators</span>
</span></span><span class="line"><span class="cl">    <span class="n">reload</span>         <span class="n">Triggers</span> <span class="n">the</span> <span class="n">agent</span> <span class="n">to</span> <span class="n">reload</span> <span class="n">configuration</span> <span class="n">files</span>
</span></span><span class="line"><span class="cl">    <span class="n">rtt</span>            <span class="n">Estimates</span> <span class="n">network</span> <span class="nb">round</span> <span class="n">trip</span> <span class="n">time</span> <span class="n">between</span> <span class="n">nodes</span>
</span></span><span class="line"><span class="cl">    <span class="n">services</span>       <span class="n">Interact</span> <span class="n">with</span> <span class="n">services</span>
</span></span><span class="line"><span class="cl">    <span class="n">snapshot</span>       <span class="n">Saves</span><span class="p">,</span> <span class="n">restores</span> <span class="ow">and</span> <span class="n">inspects</span> <span class="n">snapshots</span> <span class="n">of</span> <span class="n">Consul</span> <span class="n">server</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">    <span class="n">tls</span>            <span class="n">Builtin</span> <span class="n">helpers</span> <span class="k">for</span> <span class="n">creating</span> <span class="n">CAs</span> <span class="ow">and</span> <span class="n">certificates</span>
</span></span><span class="line"><span class="cl">    <span class="n">validate</span>       <span class="n">Validate</span> <span class="n">config</span> <span class="n">files</span><span class="o">/</span><span class="n">directories</span>
</span></span><span class="line"><span class="cl">    <span class="n">version</span>        <span class="n">Prints</span> <span class="n">the</span> <span class="n">Consul</span> <span class="n">version</span>
</span></span><span class="line"><span class="cl">    <span class="n">watch</span>          <span class="n">Watch</span> <span class="k">for</span> <span class="n">changes</span> <span class="ow">in</span> <span class="n">Consul</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="运行agent">运行Agent</h2>
<p>完成Consul的安装后，可运行Agent。Agent可以运行为Server或Client模式。每个数据中心至少必须拥有一台server，建议在一个集群中部署或者3至5个Server。部署单一的Server，在出现失败时会不可避免的造成数据丢失.</p>
<p>其他的Agent运行为Client模式，一个Client是一个非常轻量级的进程，用于注册服务，运行健康检查和转发对Server的查询，Agent必须在集群中的每个主机上运行。</p>
<h3 id="启动agent">启动Agent</h3>
<p>命令<code>consul agent -dev</code>可以启动一个开发模式的Agent，这种模式不能用于生产环境，因为它不持久化任何状态。</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ consul agent -dev
</span></span><span class="line"><span class="cl">==&gt; Starting Consul agent...
</span></span><span class="line"><span class="cl">           Version: &#39;v1.6.1&#39;
</span></span><span class="line"><span class="cl">           Node ID: &#39;2e524113-7caf-643a-80bb-a2fa00c2673b&#39;
</span></span><span class="line"><span class="cl">         Node name: &#39;C02Z35N9LVCF&#39;
</span></span><span class="line"><span class="cl">        Datacenter: &#39;dc1&#39; (Segment: &#39;&lt;all&gt;&#39;)
</span></span><span class="line"><span class="cl">            Server: true (Bootstrap: false)
</span></span><span class="line"><span class="cl">       Client Addr: [127.0.0.1] (HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600)
</span></span><span class="line"><span class="cl">      Cluster Addr: 127.0.0.1 (LAN: 8301, WAN: 8302)
</span></span><span class="line"><span class="cl">           Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false, Auto-Encrypt-TLS: false
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">==&gt; Log data will now stream in as it occurs:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [DEBUG] agent: Using random ID &#34;2e524113-7caf-643a-80bb-a2fa00c2673b&#34; as node ID
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [DEBUG] tlsutil: Update with version 1
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [DEBUG] tlsutil: OutgoingRPCWrapper with version 1
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO]  raft: Initial configuration (index=1): [{Suffrage:Voter ID:2e524113-7caf-643a-80bb-a2fa00c2673b Address:127.0.0.1:8300}]
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO]  raft: Node at 127.0.0.1:8300 [Follower] entering Follower state (Leader: &#34;&#34;)
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] serf: EventMemberJoin: C02Z35N9LVCF.dc1 127.0.0.1
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] serf: EventMemberJoin: C02Z35N9LVCF 127.0.0.1
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] consul: Adding LAN server C02Z35N9LVCF (Addr: tcp/127.0.0.1:8300) (DC: dc1)
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] consul: Handled member-join event for server &#34;C02Z35N9LVCF.dc1&#34; in area &#34;wan&#34;
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] agent: Started DNS server 127.0.0.1:8600 (tcp)
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] agent: Started DNS server 127.0.0.1:8600 (udp)
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] agent: Started HTTP server on 127.0.0.1:8500 (tcp)
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] agent: Started gRPC server on 127.0.0.1:8502 (tcp)
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] agent: started state syncer
</span></span><span class="line"><span class="cl">==&gt; Consul agent running!
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [WARN]  raft: Heartbeat timeout from &#34;&#34; reached, starting election
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO]  raft: Node at 127.0.0.1:8300 [Candidate] entering Candidate state in term 2
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [DEBUG] raft: Votes needed: 1
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [DEBUG] raft: Vote granted from 2e524113-7caf-643a-80bb-a2fa00c2673b in term 2. Tally: 1
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO]  raft: Election won. Tally: 1
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO]  raft: Node at 127.0.0.1:8300 [Leader] entering Leader state
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] consul: cluster leadership acquired
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] consul: New leader elected: C02Z35N9LVCF
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] connect: initialized primary datacenter CA with provider &#34;consul&#34;
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [DEBUG] consul: Skipping self join check for &#34;C02Z35N9LVCF&#34; since the cluster is too small
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] consul: member &#39;C02Z35N9LVCF&#39; joined, marking health alive
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [DEBUG] agent: Skipping remote check &#34;serfHealth&#34; since it is managed automatically
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [INFO] agent: Synced node info
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [DEBUG] agent: Node info in sync
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [DEBUG] agent: Skipping remote check &#34;serfHealth&#34; since it is managed automatically
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:09 [DEBUG] agent: Node info in sync
</span></span><span class="line"><span class="cl">    2019/11/20 21:56:11 [DEBUG] tlsutil: OutgoingRPCWrapper with version 1</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="集群成员">集群成员</h3>
<p>新开一个终端窗口运行<code>consul members</code>, 就可以看到Consul集群的成员。</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ consul members
</span></span><span class="line"><span class="cl">Node          Address         Status  Type    Build  Protocol  DC   Segment
</span></span><span class="line"><span class="cl">C02Z35N9LVCF  127.0.0.1:8301  alive   server  1.6.1  2         dc1  &lt;all&gt;</span></span></code></pre></td></tr></table>
</div>
</div><p>以上输出显示了我们自己的节点运行的节点、地址、健康状态、自己在集群中的角色、版本信息等。添加<code>-detailed</code>选项可以查看到额外的信息，如下：</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ consul members --detailed
</span></span><span class="line"><span class="cl">Node          Address         Status  Tags
</span></span><span class="line"><span class="cl">C02Z35N9LVCF  127.0.0.1:8301  alive   acls=0,build=1.6.1:9be6dfc+,dc=dc1,id=2e524113-7caf-643a-80bb-a2fa00c2673b,port=8300,raft_vsn=3,role=consul,segment=&lt;all&gt;,vsn=2,vsn_max=3,vsn_min=2,wan_join_port=8302</span></span></code></pre></td></tr></table>
</div>
</div><p><code>members</code>命令的输出是基于gossip协议，它是最终一致的。这意味着，在任何时候，通过你本地Agent看到的结果可能不能准确匹配server的状态。为了查看到一致的信息，可使用HTTP API(将自动转发)到Consul Server上去进行查询：</p>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ curl localhost:8500/v1/catalog/nodes
</span></span><span class="line"><span class="cl">[
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        &#34;ID&#34;: &#34;2e524113-7caf-643a-80bb-a2fa00c2673b&#34;,
</span></span><span class="line"><span class="cl">        &#34;Node&#34;: &#34;C02Z35N9LVCF&#34;,
</span></span><span class="line"><span class="cl">        &#34;Address&#34;: &#34;127.0.0.1&#34;,
</span></span><span class="line"><span class="cl">        &#34;Datacenter&#34;: &#34;dc1&#34;,
</span></span><span class="line"><span class="cl">        &#34;TaggedAddresses&#34;: {
</span></span><span class="line"><span class="cl">            &#34;lan&#34;: &#34;127.0.0.1&#34;,
</span></span><span class="line"><span class="cl">            &#34;wan&#34;: &#34;127.0.0.1&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;Meta&#34;: {
</span></span><span class="line"><span class="cl">            &#34;consul-network-segment&#34;: &#34;&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;CreateIndex&#34;: 9,
</span></span><span class="line"><span class="cl">        &#34;ModifyIndex&#34;: 10
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">]</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="停止agent">停止Agent</h3>
<p>你可以使用 Ctrl-C 优雅的关闭Agent，中断Agent之后你可以看到它离开了集群并关闭.
退出后，Consul提醒其他集群成员，这个节点离开了。如果你强行杀掉进程，集群的其他成员应该能检测到这个节点失效了。当一个成员离开，他的服务和检测也会从目录中移除。当一个成员失效了，他的健康状况被简单的标记为危险，但是不会从目录中移除。Consul会自动尝试对失效的节点进行重连，允许他从某些网络条件下恢复过来。</p>
<h2 id="注册服务">注册服务</h2>
<p>在之前的步骤我们运行了第一个agent，看到了集群的成员。现在我们将注册第一个服务并查询这些服务。</p>
<h3 id="定义一个服务">定义一个服务</h3>
<p>可以通过提供服务定义或者调用HTTP API来注册一个服务，服务定义文件是注册服务的最通用的方式。</p>
<p>首先，为Consul配置创建一个目录：</p>
<div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ sudo mkdir /etc/consul.d</span></span></code></pre></td></tr></table>
</div>
</div><p>然后，编写服务定义配置文件。假设我们有一个名叫web的服务运行在 80端口。另外，我们将给他设置一个标签，这样我们可以使用它作为额外的查询方式：</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">echo &#39;{&#34;service&#34;: {&#34;name&#34;: &#34;web&#34;, &#34;tags&#34;: [&#34;rails&#34;], &#34;port&#34;: 80}}&#39; &gt; /etc/consul.d/web.json</span></span></code></pre></td></tr></table>
</div>
</div><p>重新启动Agent，设置配置目录：</p>
<div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ sudo consul agent -dev -config-dir /etc/consul.d/web.json
</span></span><span class="line"><span class="cl">==&gt; Starting Consul agent...
</span></span><span class="line"><span class="cl">           Version: &#39;v1.6.1&#39;
</span></span><span class="line"><span class="cl">           Node ID: &#39;feba8d74-4a3a-9b42-305f-eea7da207c9c&#39;
</span></span><span class="line"><span class="cl">         Node name: &#39;C02Z35N9LVCF&#39;
</span></span><span class="line"><span class="cl">        Datacenter: &#39;dc1&#39; (Segment: &#39;&lt;all&gt;&#39;)
</span></span><span class="line"><span class="cl">            Server: true (Bootstrap: false)
</span></span><span class="line"><span class="cl">       Client Addr: [127.0.0.1] (HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600)
</span></span><span class="line"><span class="cl">      Cluster Addr: 127.0.0.1 (LAN: 8301, WAN: 8302)
</span></span><span class="line"><span class="cl">           Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false, Auto-Encrypt-TLS: false
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">==&gt; Log data will now stream in as it occurs:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [DEBUG] agent: Using random ID &#34;feba8d74-4a3a-9b42-305f-eea7da207c9c&#34; as node ID
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [DEBUG] tlsutil: Update with version 1
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [DEBUG] tlsutil: OutgoingRPCWrapper with version 1
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO]  raft: Initial configuration (index=1): [{Suffrage:Voter ID:feba8d74-4a3a-9b42-305f-eea7da207c9c Address:127.0.0.1:8300}]
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO]  raft: Node at 127.0.0.1:8300 [Follower] entering Follower state (Leader: &#34;&#34;)
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO] serf: EventMemberJoin: C02Z35N9LVCF.dc1 127.0.0.1
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO] serf: EventMemberJoin: C02Z35N9LVCF 127.0.0.1
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO] consul: Adding LAN server C02Z35N9LVCF (Addr: tcp/127.0.0.1:8300) (DC: dc1)
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO] consul: Handled member-join event for server &#34;C02Z35N9LVCF.dc1&#34; in area &#34;wan&#34;
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO] agent: Started DNS server 127.0.0.1:8600 (tcp)
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO] agent: Started DNS server 127.0.0.1:8600 (udp)
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO] agent: Started HTTP server on 127.0.0.1:8500 (tcp)
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO] agent: Started gRPC server on 127.0.0.1:8502 (tcp)
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:29 [INFO] agent: started state syncer
</span></span><span class="line"><span class="cl">==&gt; Consul agent running!
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [WARN]  raft: Heartbeat timeout from &#34;&#34; reached, starting election
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [INFO]  raft: Node at 127.0.0.1:8300 [Candidate] entering Candidate state in term 2
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [DEBUG] raft: Votes needed: 1
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [DEBUG] raft: Vote granted from feba8d74-4a3a-9b42-305f-eea7da207c9c in term 2. Tally: 1
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [INFO]  raft: Election won. Tally: 1
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [INFO]  raft: Node at 127.0.0.1:8300 [Leader] entering Leader state
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [INFO] consul: cluster leadership acquired
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [INFO] consul: New leader elected: C02Z35N9LVCF
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [INFO] connect: initialized primary datacenter CA with provider &#34;consul&#34;
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [DEBUG] consul: Skipping self join check for &#34;C02Z35N9LVCF&#34; since the cluster is too small
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [INFO] consul: member &#39;C02Z35N9LVCF&#39; joined, marking health alive
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [DEBUG] agent: Skipping remote check &#34;serfHealth&#34; since it is managed automatically
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [INFO] agent: Synced service &#34;web&#34;
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:30 [DEBUG] agent: Node info in sync
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:32 [DEBUG] tlsutil: OutgoingRPCWrapper with version 1
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:32 [DEBUG] agent: Skipping remote check &#34;serfHealth&#34; since it is managed automatically
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:32 [DEBUG] agent: Service &#34;web&#34; in sync
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:32 [DEBUG] agent: Node info in sync
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:32 [DEBUG] agent: Service &#34;web&#34; in sync
</span></span><span class="line"><span class="cl">    2019/11/20 22:17:32 [DEBUG] agent: Node info in sync</span></span></code></pre></td></tr></table>
</div>
</div><p>日志中的<code>Synced service 'web'</code>表示Agent从配置文件中载入了服务定义，并且成功注册到服务目录。</p>
<p>如果想注册多个服务，就可以在Consul配置目录创建多个服务定义文件。</p>
<h3 id="查询服务">查询服务</h3>
<p>一旦Agent启动并且服务同步了，我们可就以通过DNS或者HTTP API来查询服务。</p>
<h4 id="dns-api">DNS API</h4>
<p>我们首先使用DNS API来查询。在DNS API中，服务的DNS名字是 <code>NAME.service.consul</code>。虽然是可配置的，但默认的所有DNS名字会都在consul命名空间下，这个子域告诉Consul，我们在查询服务，<code>NAME</code>则是服务的名称.</p>
<p>对于我们上面注册的Web服务.它的域名是 <code>web.service.consul</code>:</p>
<div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ dig @127.0.0.1 -p 8600 web.service.consul
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 web.service.consul
</span></span><span class="line"><span class="cl">; (1 server found)
</span></span><span class="line"><span class="cl">;; global options: +cmd
</span></span><span class="line"><span class="cl">;; Got answer:
</span></span><span class="line"><span class="cl">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 27222
</span></span><span class="line"><span class="cl">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2
</span></span><span class="line"><span class="cl">;; WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">;; OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl">; EDNS: version: 0, flags:; udp: 4096
</span></span><span class="line"><span class="cl">;; QUESTION SECTION:
</span></span><span class="line"><span class="cl">;web.service.consul.                IN        A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">;; ANSWER SECTION:
</span></span><span class="line"><span class="cl">web.service.consul.        0        IN        A        127.0.0.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">;; ADDITIONAL SECTION:
</span></span><span class="line"><span class="cl">web.service.consul.        0        IN        TXT        &#34;consul-network-segment=&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">;; Query time: 8 msec
</span></span><span class="line"><span class="cl">;; SERVER: 127.0.0.1#8600(127.0.0.1)
</span></span><span class="line"><span class="cl">;; WHEN: Wed Nov 20 22:26:14 CST 2019
</span></span><span class="line"><span class="cl">;; MSG SIZE  rcvd: 99</span></span></code></pre></td></tr></table>
</div>
</div><p>如你所见,一个A记录返回了一个可用的服务所在的节点的IP地址。A记录只能设置为IP地址，有也可用使用 DNS API 来接收包含地址和端口的 <code>SRV</code> 记录：</p>
<div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ dig @127.0.0.1 -p 8600 web.service.consul SRV
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 web.service.consul SRV
</span></span><span class="line"><span class="cl">; (1 server found)
</span></span><span class="line"><span class="cl">;; global options: +cmd
</span></span><span class="line"><span class="cl">;; Got answer:
</span></span><span class="line"><span class="cl">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 49043
</span></span><span class="line"><span class="cl">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 3
</span></span><span class="line"><span class="cl">;; WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">;; OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl">; EDNS: version: 0, flags:; udp: 4096
</span></span><span class="line"><span class="cl">;; QUESTION SECTION:
</span></span><span class="line"><span class="cl">;web.service.consul.                IN        SRV
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">;; ANSWER SECTION:
</span></span><span class="line"><span class="cl">web.service.consul.        0        IN        SRV        1 1 80 C02Z35N9LVCF.node.dc1.consul.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">;; ADDITIONAL SECTION:
</span></span><span class="line"><span class="cl">C02Z35N9LVCF.node.dc1.consul. 0        IN        A        127.0.0.1
</span></span><span class="line"><span class="cl">C02Z35N9LVCF.node.dc1.consul. 0        IN        TXT        &#34;consul-network-segment=&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">;; Query time: 1 msec
</span></span><span class="line"><span class="cl">;; SERVER: 127.0.0.1#8600(127.0.0.1)
</span></span><span class="line"><span class="cl">;; WHEN: Wed Nov 20 22:28:14 CST 2019
</span></span><span class="line"><span class="cl">;; MSG SIZE  rcvd: 147</span></span></code></pre></td></tr></table>
</div>
</div><p><code>SRV</code>记录告诉我们 web 这个服务运行于节点<code>C02Z35N9LVCF.node.dc1.consul</code> 的80端口，DNS额外返回了节点的A记录。</p>
<p>最后，我们也可以用 DNS API 通过标签来过滤服务，基于标签的服务查询格式为<code>TAG.NAME.service.consul</code>。在下面的例子中，我们请求Consul返回有 rails标签的 web服务：</p>
<div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ dig @127.0.0.1 -p 8600 rails.web.service.consul SRV
</span></span><span class="line"><span class="cl"># 输出信息略</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="http-api">HTTP API</h4>
<p>除了DNS API之外，也可以使用HTTP API查询所有服务实例：</p>
<div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ curl http://localhost:8500/v1/catalog/service/web
</span></span><span class="line"><span class="cl">[
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        &#34;ID&#34;: &#34;feba8d74-4a3a-9b42-305f-eea7da207c9c&#34;,
</span></span><span class="line"><span class="cl">        &#34;Node&#34;: &#34;C02Z35N9LVCF&#34;,
</span></span><span class="line"><span class="cl">        &#34;Address&#34;: &#34;127.0.0.1&#34;,
</span></span><span class="line"><span class="cl">        &#34;Datacenter&#34;: &#34;dc1&#34;,
</span></span><span class="line"><span class="cl">        &#34;TaggedAddresses&#34;: {
</span></span><span class="line"><span class="cl">            &#34;lan&#34;: &#34;127.0.0.1&#34;,
</span></span><span class="line"><span class="cl">            &#34;wan&#34;: &#34;127.0.0.1&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;NodeMeta&#34;: {
</span></span><span class="line"><span class="cl">            &#34;consul-network-segment&#34;: &#34;&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;ServiceKind&#34;: &#34;&#34;,
</span></span><span class="line"><span class="cl">        &#34;ServiceID&#34;: &#34;web&#34;,
</span></span><span class="line"><span class="cl">        &#34;ServiceName&#34;: &#34;web&#34;,
</span></span><span class="line"><span class="cl">        &#34;ServiceTags&#34;: [
</span></span><span class="line"><span class="cl">            &#34;rails&#34;
</span></span><span class="line"><span class="cl">        ],
</span></span><span class="line"><span class="cl">        &#34;ServiceAddress&#34;: &#34;&#34;,
</span></span><span class="line"><span class="cl">        &#34;ServiceWeights&#34;: {
</span></span><span class="line"><span class="cl">            &#34;Passing&#34;: 1,
</span></span><span class="line"><span class="cl">            &#34;Warning&#34;: 1
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;ServiceMeta&#34;: {},
</span></span><span class="line"><span class="cl">        &#34;ServicePort&#34;: 80,
</span></span><span class="line"><span class="cl">        &#34;ServiceEnableTagOverride&#34;: false,
</span></span><span class="line"><span class="cl">        &#34;ServiceProxy&#34;: {
</span></span><span class="line"><span class="cl">            &#34;MeshGateway&#34;: {}
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;ServiceConnect&#34;: {},
</span></span><span class="line"><span class="cl">        &#34;CreateIndex&#34;: 10,
</span></span><span class="line"><span class="cl">        &#34;ModifyIndex&#34;: 10
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">]</span></span></code></pre></td></tr></table>
</div>
</div><p>只查看健康服务实例的方法：</p>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ curl http://localhost:8500/v1/catalog/service/web?passing
</span></span><span class="line"><span class="cl"># 输出信息略</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="更新服务">更新服务</h3>
<p>服务定义可以通过修改配置文件并发送<code>SIGHUP</code>给Agent来进行更新，这样可以在不关闭服务或者保持服务请求可用的情况下进行更新。</p>
<p>参考来源：</p>
<ol>
<li><a href="https://github.com/hashicorp/consul"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/hashicorp/consul<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://www.consul.io/intro/getting-started.html"target="_blank" rel="external nofollow noopener noreferrer">https://www.consul.io/intro/getting-started.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://book-consul-guide.vnzmi.com/01_what_is_consul.html"target="_blank" rel="external nofollow noopener noreferrer">https://book-consul-guide.vnzmi.com/01_what_is_consul.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ol>
]]></description></item></channel></rss>