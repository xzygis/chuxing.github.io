<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Websocket介绍 - 楚兴的技术笔记</title><meta name=author content="chuxing"><meta name=author-link content="https://github.com/xzygis"><meta name=description content="什么是WebSocket？ WebSocket是一种网络传输协议，可在单个TCP连接上进行全双工通信，位于OSI模型的应用层。WebSocket协议在2011年由IETF标准化为RFC 6455，后由RFC 7936补充规范。 WebSocket使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向"><meta name=keywords content="websocket"><meta itemprop=name content="Websocket介绍"><meta itemprop=description content="什么是WebSocket？ WebSocket是一种网络传输协议，可在单个TCP连接上进行全双工通信，位于OSI模型的应用层。WebSocket协议在2011年由IETF标准化为RFC 6455，后由RFC 7936补充规范。 WebSocket使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向"><meta itemprop=datePublished content="2021-06-12T15:25:21+00:00"><meta itemprop=dateModified content="2022-12-10T14:35:38+08:00"><meta itemprop=wordCount content="6392"><meta itemprop=image content="https://xzygis.github.io/logo.png"><meta itemprop=keywords content="websocket,"><meta property="og:title" content="Websocket介绍"><meta property="og:description" content="什么是WebSocket？ WebSocket是一种网络传输协议，可在单个TCP连接上进行全双工通信，位于OSI模型的应用层。WebSocket协议在2011年由IETF标准化为RFC 6455，后由RFC 7936补充规范。 WebSocket使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向"><meta property="og:type" content="article"><meta property="og:url" content="https://xzygis.github.io/posts/introduction-of-websocket/"><meta property="og:image" content="https://xzygis.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-12T15:25:21+00:00"><meta property="article:modified_time" content="2022-12-10T14:35:38+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://xzygis.github.io/logo.png"><meta name=twitter:title content="Websocket介绍"><meta name=twitter:description content="什么是WebSocket？ WebSocket是一种网络传输协议，可在单个TCP连接上进行全双工通信，位于OSI模型的应用层。WebSocket协议在2011年由IETF标准化为RFC 6455，后由RFC 7936补充规范。 WebSocket使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向"><meta name=application-name content="楚兴的技术笔记"><meta name=apple-mobile-web-app-title content="楚兴的技术笔记"><meta name=theme-color data-light=#ffffff data-dark=#252627 content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://xzygis.github.io/posts/introduction-of-websocket/><link rel=prev href=https://xzygis.github.io/posts/manual-of-consul/><link rel=next href=https://xzygis.github.io/posts/three-ways-to-transfer-files-in-linux/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Websocket介绍","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/xzygis.github.io\/posts\/introduction-of-websocket\/"},"image":["https:\/\/xzygis.github.io\/site-meta.jpg"],"genre":"posts","keywords":"websocket","wordcount":6392,"url":"https:\/\/xzygis.github.io\/posts\/introduction-of-websocket\/","datePublished":"2021-06-12T15:25:21+00:00","dateModified":"2022-12-10T14:35:38+08:00","publisher":{"@type":"Organization","name":"xzygis","logo":"https:\/\/xzygis.github.io\/images\/avatar.jpg"},"author":{"@type":"Person","name":"chuxing"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title=楚兴的技术笔记><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo.png data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x" data-sizes=auto alt=楚兴的技术笔记 title=楚兴的技术笔记><span class=header-title-text>技术杂谈</span></a><span class=header-subtitle>提升认知，知行合一</span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class=menu-item><a class=menu-link href=/about/ title=About>About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=楚兴的技术笔记><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo.png data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x" data-sizes=auto alt=/logo.png title=/logo.png><span class=header-title-text>技术杂谈</span></a><span class=header-subtitle>提升认知，知行合一</span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class=menu-item><a class=menu-link href=/about/ title=About>About</a></li><li class="menu-item text-center"><a class=menu-link href=https://github.com/xzygis/xzygis.github.io title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container data-page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Websocket介绍</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/xzygis title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class="lazyload avatar" src=/svg/loading.min.svg data-src=/images/avatar.jpg data-srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" data-sizes=auto alt=chuxing title=chuxing>&nbsp;chuxing</a></span>
<span class=post-category>收录于 <a href=/categories/http/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> HTTP</a></span></div><div class=post-meta-line><span title="2021-06-12 15:25:21"><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-06-12>2021-06-12</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden=true></i> 约 6392 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden=true></i> 预计阅读 13 分钟</span>&nbsp;<span id=/posts/introduction-of-websocket/ class="leancloud_visitors comment-visitors" data-flag-title=Websocket介绍>
<i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count>-</span>&nbsp;次阅读
</span>&nbsp;<span class=comment-count data-flag-title=Websocket介绍>
<i class="fa-regular fa-comments fa-fw" aria-hidden=true></i>&nbsp;<span data-xid=/posts/introduction-of-websocket/ class=valine-comment-count>-</span>&nbsp;条评论
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#什么是websocket>什么是WebSocket？</a><ul><li><a href=#有哪些优点>有哪些优点？</a></li></ul></li><li><a href=#握手协议>握手协议</a><ul><li><a href=#握手例子>握手例子</a></li><li><a href=#字段说明>字段说明</a></li><li><a href=#体验一下>体验一下</a></li></ul></li><li><a href=#数据帧>数据帧</a><ul><li><a href=#帧结构>帧结构</a></li><li><a href=#字段说明-1>字段说明</a></li><li><a href=#掩码算法>掩码算法</a></li></ul></li><li><a href=#数据传递>数据传递</a><ul><li><a href=#数据分片>数据分片</a></li><li><a href=#数据分片例子>数据分片例子</a></li></ul></li><li><a href=#心跳>心跳</a></li><li><a href=#安全性>安全性</a></li><li><a href=#go实战gorilla-websocket>Go实战：Gorilla WebSocket</a><ul><li><a href=#upgrade>Upgrade</a></li><li><a href=#readmessage>ReadMessage</a></li><li><a href=#writemessage>WriteMessage</a></li></ul></li></ul></nav></div></div><div class=content id=content data-end-flag=(End)><h2 id=什么是websocket>什么是WebSocket？</h2><p>WebSocket是一种网络传输协议，可在单个TCP连接上进行全双工通信，位于OSI模型的应用层。WebSocket协议在2011年由IETF标准化为RFC 6455，后由RFC 7936补充规范。</p><p>WebSocket使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在WebSocket API中，浏览器和服务器只需要完成一次握手，两者之间就可以创建持久性的连接，并进行双向数据传输。</p><h3 id=有哪些优点>有哪些优点？</h3><ol><li>较少的控制开销。在连接创建后，服务器和客户端之间交换数据时，用于协议控制的数据包头部相对较小。在不包含扩展的情况下，对于服务器到客户端的内容，此头部大小只有2至10字节（和数据包长度有关）；对于客户端到服务器的内容，此头部还需要加上额外的4字节的掩码。相对于HTTP请求每次都要携带完整的头部，此项开销显著减少了。</li><li>强的实时性。由于协议是全双工的，所以服务器可以随时主动给客户端下发数据。相对于HTTP请求需要等待客户端发起请求服务端才能响应，延迟明显更少；即使是和Comet等类似的长轮询比较，其也能在短时间内更多次地传递数据。</li><li>保持连接状态。与HTTP不同的是，Websocket需要先创建连接，这就使得其成为一种有状态的协议，之后通信时可以省略部分状态信息。而HTTP请求可能需要在每个请求都携带状态信息（如身份认证等）。</li><li>更好的二进制支持。Websocket定义了二进制帧，相对HTTP，可以更轻松地处理二进制内容。</li><li>可以支持扩展。Websocket定义了扩展，用户可以扩展协议、实现部分自定义的子协议。如部分浏览器支持压缩等。</li></ol><h2 id=握手协议>握手协议</h2><p>WebSocket是一种与HTTP不同的协议。两者都位于OSI模型的应用层，并且都依赖于传输层的TCP协议。 虽然它们不同，但是RFC 6455中规定：it is designed to work over HTTP ports 80 and 443 as well as to support HTTP proxies and intermediaries（WebSocket通过HTTP端口80和443进行工作，并支持HTTP代理和中介），从而使其与HTTP协议兼容。 为了实现兼容性，WebSocket握手使用HTTP Upgrade头从HTTP协议更改为WebSocket协议。</p><h3 id=握手例子>握手例子</h3><p>一个典型的Websocket握手请求如下：</p><p>客户端请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /chat HTTP/1.1
</span></span><span class=line><span class=cl>Host: server.example.com
</span></span><span class=line><span class=cl>Upgrade: websocket
</span></span><span class=line><span class=cl>Connection: Upgrade
</span></span><span class=line><span class=cl>Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
</span></span><span class=line><span class=cl>Origin: http://example.com
</span></span><span class=line><span class=cl>Sec-WebSocket-Protocol: chat, superchat
</span></span><span class=line><span class=cl>Sec-WebSocket-Version: 13
</span></span></code></pre></td></tr></table></div></div><p>服务器回应：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 101 Switching Protocols
</span></span><span class=line><span class=cl>Upgrade: websocket
</span></span><span class=line><span class=cl>Connection: Upgrade
</span></span><span class=line><span class=cl>Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
</span></span><span class=line><span class=cl>Sec-WebSocket-Protocol: chat
</span></span></code></pre></td></tr></table></div></div><h3 id=字段说明>字段说明</h3><ul><li>Connection必须设置Upgrade，表示客户端希望连接升级。</li><li>Upgrade字段必须设置Websocket，表示希望升级到Websocket协议。</li><li>Sec-WebSocket-Key是随机的字符串，服务器端会用这些数据来构造出一个SHA-1的信息摘要。把“Sec-WebSocket-Key”加上一个特殊字符串“258EAFA5-E914-47DA-95CA-C5AB0DC85B11”，然后计算SHA-1摘要，之后进行Base64编码，将结果做为“Sec-WebSocket-Accept”头的值，返回给客户端。如此操作，可以尽量避免普通HTTP请求被误认为Websocket协议。</li><li>Sec-WebSocket-Version 表示支持的Websocket版本。RFC6455要求使用的版本是13，之前草案的版本均应当弃用。</li><li>Origin字段是必须的。如果缺少origin字段，WebSocket服务器需要回复HTTP 403 状态码（禁止访问）。</li></ul><h3 id=体验一下>体验一下</h3><blockquote><p><a href=https://www.websocket.org/echo.html target=_blank rel="external nofollow noopener noreferrer">https://www.websocket.org/echo.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></p></blockquote><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/introduction-of-websocket/websocket.org-1.png data-srcset="/posts/introduction-of-websocket/websocket.org-1.png, /posts/introduction-of-websocket/websocket.org-1.png 1.5x, /posts/introduction-of-websocket/websocket.org-1.png 2x" data-sizes=auto alt=Connect title=Connect width=1280 height=594></p><p>握手报文：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/introduction-of-websocket/websocket.org-2.png data-srcset="/posts/introduction-of-websocket/websocket.org-2.png, /posts/introduction-of-websocket/websocket.org-2.png 1.5x, /posts/introduction-of-websocket/websocket.org-2.png 2x" data-sizes=auto alt=握手报文 title=握手报文 width=1280 height=1104></p><p>数据传输：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/introduction-of-websocket/websocket.org-3.png data-srcset="/posts/introduction-of-websocket/websocket.org-3.png, /posts/introduction-of-websocket/websocket.org-3.png 1.5x, /posts/introduction-of-websocket/websocket.org-3.png 2x" data-sizes=auto alt=握手报文 title=握手报文 width=1280 height=911></p><h2 id=数据帧>数据帧</h2><p>WebSocket客户端、服务端通信的最小单位是帧（frame），由1个或多个帧组成一条完整的消息（message）。</p><ul><li>发送端：将消息切割成多个帧，并发送给服务端；</li><li>接收端：接收消息帧，并将关联的帧重新组装成完整的消息；</li></ul><h3 id=帧结构>帧结构</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> +-+-+-+-+-------+-+-------------+-------------------------------+
</span></span><span class=line><span class=cl> |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
</span></span><span class=line><span class=cl> |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
</span></span><span class=line><span class=cl> |N|V|V|V|       |S|             |   (if payload len==126/127)   |
</span></span><span class=line><span class=cl> | |1|2|3|       |K|             |                               |
</span></span><span class=line><span class=cl> +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
</span></span><span class=line><span class=cl> |     Extended payload length continued, if payload len == 127  |
</span></span><span class=line><span class=cl> + - - - - - - - - - - - - - - - +-------------------------------+
</span></span><span class=line><span class=cl> |                               |Masking-key, if MASK set to 1  |
</span></span><span class=line><span class=cl> +-------------------------------+-------------------------------+
</span></span><span class=line><span class=cl> | Masking-key (continued)       |          Payload Data         |
</span></span><span class=line><span class=cl> +-------------------------------- - - - - - - - - - - - - - - - +
</span></span><span class=line><span class=cl> :                     Payload Data continued ...                :
</span></span><span class=line><span class=cl> + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
</span></span><span class=line><span class=cl> |                     Payload Data continued ...                |
</span></span><span class=line><span class=cl> +---------------------------------------------------------------+
</span></span></code></pre></td></tr></table></div></div><h3 id=字段说明-1>字段说明</h3><p>FIN：1个比特。
如果是1，表示这是消息（message）的最后一个分片（fragment），如果是0，表示不是是消息（message）的最后一个分片（fragment）。</p><p>RSV1, RSV2, RSV3：各占1个比特。
一般情况下全为0。当客户端、服务端协商采用WebSocket扩展时，这三个标志位可以非0，且值的含义由扩展进行定义。如果出现非零的值，且并没有采用WebSocket扩展，连接出错。</p><p>Opcode: 4个比特。
操作代码，Opcode的值决定了应该如何解析后续的数据载荷（data payload）。如果操作代码是不认识的，那么接收端应该断开连接（fail the connection）。可选的操作代码如下：</p><ul><li>%x0：表示一个延续帧。当Opcode为0时，表示本次数据传输采用了数据分片，当前收到的数据帧为其中一个数据分片。</li><li>%x1：表示这是一个文本帧（frame）</li><li>%x2：表示这是一个二进制帧（frame）</li><li>%x3-7：保留的操作代码，用于后续定义的非控制帧。</li><li>%x8：表示连接断开。</li><li>%x9：表示这是一个ping操作。</li><li>%xA：表示这是一个pong操作。</li><li>%xB-F：保留的操作代码，用于后续定义的控制帧。</li></ul><p>Mask: 1个比特。
表示是否要对数据载荷进行掩码操作。从客户端向服务端发送数据时，需要对数据进行掩码操作；从服务端向客户端发送数据时，不需要对数据进行掩码操作。
如果服务端接收到的数据没有进行过掩码操作，服务端需要断开连接。
如果Mask是1，那么在Masking-key中会定义一个掩码键（masking key），并用这个掩码键来对数据载荷进行反掩码。所有客户端发送到服务端的数据帧，Mask都是1。
掩码的算法、用途在下一小节讲解。</p><p>Payload length：数据载荷的长度，单位是字节。为7位，或7+16位，或1+64位。
假设数Payload length === x，如果</p><ul><li>x为0~126：数据的长度为x字节。</li><li>x为126：后续2个字节代表一个16位的无符号整数，该无符号整数的值为数据的长度。</li><li>x为127：后续8个字节代表一个64位的无符号整数（最高位为0），该无符号整数的值为数据的长度。</li></ul><p>此外，如果payload length占用了多个字节的话，payload length的二进制表达采用网络序（big endian，重要的位在前）。</p><p>Masking-key：0或4字节（32位）
所有从客户端传送到服务端的数据帧，数据载荷都进行了掩码操作，Mask为1，且携带了4字节的Masking-key。如果Mask为0，则没有Masking-key。
备注：载荷数据的长度，不包括mask key的长度。</p><p>Payload data：(x+y) 字节</p><ul><li>载荷数据：包括了扩展数据、应用数据。其中，扩展数据x字节，应用数据y字节。</li><li>扩展数据：如果没有协商使用扩展的话，扩展数据数据为0字节。所有的扩展都必须声明扩展数据的长度，或者可以如何计算出扩展数据的长度。此外，扩展如何使用必须在握手阶段就协商好。如果扩展数据存在，那么载荷数据长度必须将扩展数据的长度包含在内。</li><li>应用数据：任意的应用数据，在扩展数据之后（如果存在扩展数据），占据了数据帧剩余的位置。载荷数据长度 减去 扩展数据长度，就得到应用数据的长度。</li></ul><h3 id=掩码算法>掩码算法</h3><p>掩码键（Masking-key）是由客户端挑选出来的32位的随机数。掩码操作不会影响数据载荷的长度。掩码、反掩码操作都采用如下算法：</p><p>首先，预设：</p><ul><li>original-octet-i：为原始数据的第i字节。</li><li>transformed-octet-i：为转换后的数据的第i字节。</li><li>j：为i mod 4的结果。</li><li>masking-key-octet-j：为mask key第j字节。</li></ul><p>流程为： original-octet-i 与 masking-key-octet-j 异或后，得到 transformed-octet-i。</p><p>伪代码大概是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>var DECODED = &#34;&#34;;
</span></span><span class=line><span class=cl>for (var i = 0; i &lt; ENCODED.length; i++) {
</span></span><span class=line><span class=cl>    DECODED[i] = ENCODED[i] ^ MASK[i % 4];
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>数据掩码的作用：
WebSocket 协议中，数据掩码的作用是增强协议的安全性。但数据掩码并不是为了保护数据本身，因为算法本身是公开的，运算也不复杂。除了加密通道本身，似乎没有太多有效的保护通信安全的办法。
那么为什么还要引入掩码计算呢，除了增加计算机器的运算量外似乎并没有太多的收益（这也是不少同学疑惑的点）。
答案还是两个字：安全。但并不是为了防止数据泄密，而是为了防止早期版本的协议中存在的代理缓存污染攻击（proxy cache poisoning attacks）等问题。</p><h2 id=数据传递>数据传递</h2><p>一旦WebSocket客户端、服务端建立连接后，后续的操作都是基于数据帧的传递。
WebSocket根据opcode来区分操作的类型。比如0x8表示断开连接，0x0-0x2表示数据交互。</p><h3 id=数据分片>数据分片</h3><p>WebSocket的每条消息可能被切分成多个数据帧。当WebSocket的接收方收到一个数据帧时，会根据FIN的值来判断，是否已经收到消息的最后一个数据帧。
FIN=1表示当前数据帧为消息的最后一个数据帧，此时接收方已经收到完整的消息，可以对消息进行处理。FIN=0，则接收方还需要继续监听接收其余的数据帧。
此外，opcode在数据交换的场景下，表示的是数据的类型。0x01表示文本，0x02表示二进制。而0x00比较特殊，表示延续帧（continuation frame），顾名思义，就是完整消息对应的数据帧还没接收完。</p><h3 id=数据分片例子>数据分片例子</h3><p>下面例子来自MDN，可以很好地演示数据的分片。客户端向服务端两次发送消息，服务端收到消息后回应客户端，这里主要看客户端往服务端发送的消息。</p><p><em>第一条消息</em></p><p>FIN=1, 表示是当前消息的最后一个数据帧。服务端收到当前数据帧后，可以处理消息。opcode=0x1，表示客户端发送的是文本类型。</p><p><em>第二条消息</em></p><ol><li>FIN=0，opcode=0x1，表示发送的是文本类型，且消息还没发送完成，还有后续的数据帧。</li><li>FIN=0，opcode=0x0，表示消息还没发送完成，还有后续的数据帧，当前的数据帧需要接在上一条数据帧之后。</li><li>FIN=1，opcode=0x0，表示消息已经发送完成，没有后续的数据帧，当前的数据帧需要接在上一条数据帧之后。服务端可以将关联的数据帧组装成完整的消息。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Client: FIN=1, opcode=0x1, msg=&#34;hello&#34;
</span></span><span class=line><span class=cl>Server: (process complete message immediately) Hi.
</span></span><span class=line><span class=cl>Client: FIN=0, opcode=0x1, msg=&#34;and a&#34;
</span></span><span class=line><span class=cl>Server: (listening, new message containing text started)
</span></span><span class=line><span class=cl>Client: FIN=0, opcode=0x0, msg=&#34;happy new&#34;
</span></span><span class=line><span class=cl>Server: (listening, payload concatenated to previous message)
</span></span><span class=line><span class=cl>Client: FIN=1, opcode=0x0, msg=&#34;year!&#34;
</span></span><span class=line><span class=cl>Server: (process complete message) Happy new year to you too!
</span></span></code></pre></td></tr></table></div></div><h2 id=心跳>心跳</h2><p>WebSocket 为了保持客户端、服务端的实时双向通信，需要确保客户端、服务端之间的 TCP 通道保持连接没有断开。
对于长时间没有数据往来的连接，如果依旧长时间保持着，可能会浪费包括的连接资源。但不排除有些场景，客户端、服务端虽然长时间没有数据往来，但仍需要保持连接。这个时候，可以采用心跳来实现。</p><ul><li>发送方 -> 接收方：ping</li><li>接收方 -> 发送方：pong</li></ul><p>ping、pong 的操作，对应的是 WebSocket 的两个控制帧，opcode分别是0x9、0xA。</p><h2 id=安全性>安全性</h2><p>WebSocket协议中规定在连接建立时检查Upgrade请求中的某些字段（如Origin，查看每次请求是否一致），对于不符合要求的请求立即断开，在通信过程中，也对Frame中的控制位做了很多限制，以便禁止异常连接。
websocket协议中也规定了数据加密传输的方式，允许使用TLS/SSL来对通信加密，默认ws的端口为80，wss端口为433，类似HTTP与HTTPS。</p><h2 id=go实战gorilla-websocket>Go实战：Gorilla WebSocket</h2><blockquote><p>Github：https://github.com/gorilla/websocket</p></blockquote><p>文件监控例子（当文件被修改后，把文件发给客户端）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func main() {
</span></span><span class=line><span class=cl>   http.HandleFunc(&#34;/ws&#34;, serveWs)
</span></span><span class=line><span class=cl>   if err := http.ListenAndServe(*addr, nil); err != nil {
</span></span><span class=line><span class=cl>      log.Fatal(err)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func serveWs(w http.ResponseWriter, r *http.Request) {
</span></span><span class=line><span class=cl>   //升级为Websocket协议
</span></span><span class=line><span class=cl>   ws, err := upgrader.Upgrade(w, r, nil)
</span></span><span class=line><span class=cl>   if err != nil {
</span></span><span class=line><span class=cl>      if _, ok := err.(websocket.HandshakeError); !ok {
</span></span><span class=line><span class=cl>         log.Println(err)
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      return
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   var lastMod time.Time
</span></span><span class=line><span class=cl>   if n, err := strconv.ParseInt(r.FormValue(&#34;lastMod&#34;), 16, 64); err == nil {
</span></span><span class=line><span class=cl>      lastMod = time.Unix(0, n)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   go writer(ws, lastMod) //发送数据、Pong
</span></span><span class=line><span class=cl>   reader(ws) //读数据、处理Ping
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func writer(ws *websocket.Conn, lastMod time.Time) {
</span></span><span class=line><span class=cl>   pingTicker := time.NewTicker(pingPeriod)
</span></span><span class=line><span class=cl>   fileTicker := time.NewTicker(filePeriod)
</span></span><span class=line><span class=cl>   ...
</span></span><span class=line><span class=cl>   for {
</span></span><span class=line><span class=cl>      select {
</span></span><span class=line><span class=cl>      case &lt;-fileTicker.C:
</span></span><span class=line><span class=cl>         p, fileModified, err := readFileIfModified(lastMod)
</span></span><span class=line><span class=cl>         ...
</span></span><span class=line><span class=cl>         if fileModified {
</span></span><span class=line><span class=cl>            ws.SetWriteDeadline(time.Now().Add(writeWait))
</span></span><span class=line><span class=cl>            if err := ws.WriteMessage(websocket.TextMessage, p); err != nil {
</span></span><span class=line><span class=cl>               return
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>         }
</span></span><span class=line><span class=cl>      case &lt;-pingTicker.C:
</span></span><span class=line><span class=cl>         ws.SetWriteDeadline(time.Now().Add(writeWait))
</span></span><span class=line><span class=cl>         if err := ws.WriteMessage(websocket.PingMessage, []byte{}); err != nil {
</span></span><span class=line><span class=cl>            return
</span></span><span class=line><span class=cl>         }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func reader(ws *websocket.Conn) {
</span></span><span class=line><span class=cl>   defer ws.Close()
</span></span><span class=line><span class=cl>   ws.SetReadLimit(512)
</span></span><span class=line><span class=cl>   ws.SetReadDeadline(time.Now().Add(pongWait))
</span></span><span class=line><span class=cl>   ws.SetPongHandler(func(string) error { ws.SetReadDeadline(time.Now().Add(pongWait)); return nil })
</span></span><span class=line><span class=cl>   for {
</span></span><span class=line><span class=cl>      _, _, err := ws.ReadMessage()
</span></span><span class=line><span class=cl>      if err != nil {
</span></span><span class=line><span class=cl>         break
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>其中最重要的几个方法是Upgrade、ReadMessage和WriteMessage，下面逐一介绍。</p><h3 id=upgrade>Upgrade</h3><p>协议升级</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// Upgrade upgrades the HTTP server connection to the WebSocket protocol.
</span></span><span class=line><span class=cl>func (u *Upgrader) Upgrade(w http.ResponseWriter, r *http.Request, responseHeader http.Header) (*Conn, error) {
</span></span><span class=line><span class=cl>   const badHandshake = &#34;websocket: the client is not using the websocket protocol: &#34;
</span></span><span class=line><span class=cl>   //检查必要的头部字段
</span></span><span class=line><span class=cl>   if !tokenListContainsValue(r.Header, &#34;Connection&#34;, &#34;upgrade&#34;) {
</span></span><span class=line><span class=cl>      return u.returnError(w, r, http.StatusBadRequest, badHandshake+&#34;&#39;upgrade&#39; token not found in &#39;Connection&#39; header&#34;)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   if !tokenListContainsValue(r.Header, &#34;Upgrade&#34;, &#34;websocket&#34;) {
</span></span><span class=line><span class=cl>      return u.returnError(w, r, http.StatusBadRequest, badHandshake+&#34;&#39;websocket&#39; token not found in &#39;Upgrade&#39; header&#34;)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   if r.Method != &#34;GET&#34; {
</span></span><span class=line><span class=cl>      return u.returnError(w, r, http.StatusMethodNotAllowed, badHandshake+&#34;request method is not GET&#34;)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   if !tokenListContainsValue(r.Header, &#34;Sec-Websocket-Version&#34;, &#34;13&#34;) {
</span></span><span class=line><span class=cl>      return u.returnError(w, r, http.StatusBadRequest, &#34;websocket: unsupported version: 13 not found in &#39;Sec-Websocket-Version&#39; header&#34;)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   if !checkOrigin(r) {
</span></span><span class=line><span class=cl>      return u.returnError(w, r, http.StatusForbidden, &#34;websocket: request origin not allowed by Upgrader.CheckOrigin&#34;)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   challengeKey := r.Header.Get(&#34;Sec-Websocket-Key&#34;)
</span></span><span class=line><span class=cl>   if challengeKey == &#34;&#34; {
</span></span><span class=line><span class=cl>      return u.returnError(w, r, http.StatusBadRequest, &#34;websocket: not a websocket handshake: &#39;Sec-WebSocket-Key&#39; header is missing or blank&#34;)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   h, ok := w.(http.Hijacker)
</span></span><span class=line><span class=cl>   if !ok {
</span></span><span class=line><span class=cl>      return u.returnError(w, r, http.StatusInternalServerError, &#34;websocket: response does not implement http.Hijacker&#34;)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   //创建websocket.Conn
</span></span><span class=line><span class=cl>   c := newConn(netConn, true, u.ReadBufferSize, u.WriteBufferSize, u.WriteBufferPool, br, writeBuf)
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>   var p []byte
</span></span><span class=line><span class=cl>   p = append(p, &#34;HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: &#34;...)
</span></span><span class=line><span class=cl>   p = append(p, computeAcceptKey(challengeKey)...) //计算accept
</span></span><span class=line><span class=cl>   p = append(p, &#34;\r\n&#34;...)
</span></span><span class=line><span class=cl>   if c.subprotocol != &#34;&#34; {
</span></span><span class=line><span class=cl>      p = append(p, &#34;Sec-WebSocket-Protocol: &#34;...)
</span></span><span class=line><span class=cl>      p = append(p, c.subprotocol...)
</span></span><span class=line><span class=cl>      p = append(p, &#34;\r\n&#34;...)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   if _, err = netConn.Write(p); err != nil {
</span></span><span class=line><span class=cl>      netConn.Close()
</span></span><span class=line><span class=cl>      return nil, err
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   return c, nil
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>var keyGUID = []byte(&#34;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#34;)
</span></span><span class=line><span class=cl>func computeAcceptKey(challengeKey string) string {
</span></span><span class=line><span class=cl>   h := sha1.New()
</span></span><span class=line><span class=cl>   h.Write([]byte(challengeKey))
</span></span><span class=line><span class=cl>   h.Write(keyGUID)
</span></span><span class=line><span class=cl>   return base64.StdEncoding.EncodeToString(h.Sum(nil))
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func newConn(conn net.Conn, isServer bool, readBufferSize, writeBufferSize int, writeBufferPool BufferPool, br *bufio.Reader, writeBuf []byte) *Conn {
</span></span><span class=line><span class=cl>   c := &amp;Conn{
</span></span><span class=line><span class=cl>      isServer:               isServer,
</span></span><span class=line><span class=cl>      br:                     br,
</span></span><span class=line><span class=cl>      conn:                   conn,
</span></span><span class=line><span class=cl>      mu:                     mu,
</span></span><span class=line><span class=cl>      readFinal:              true,
</span></span><span class=line><span class=cl>      writeBuf:               writeBuf,
</span></span><span class=line><span class=cl>      writePool:              writeBufferPool,
</span></span><span class=line><span class=cl>      writeBufSize:           writeBufferSize,
</span></span><span class=line><span class=cl>      enableWriteCompression: true,
</span></span><span class=line><span class=cl>      compressionLevel:       defaultCompressionLevel,
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   //设置对应的消息处理Handler
</span></span><span class=line><span class=cl>   c.SetCloseHandler(nil)
</span></span><span class=line><span class=cl>   c.SetPingHandler(nil)
</span></span><span class=line><span class=cl>   c.SetPongHandler(nil)
</span></span><span class=line><span class=cl>   return c
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func (c *Conn) SetCloseHandler(h func(code int, text string) error) {
</span></span><span class=line><span class=cl>   if h == nil {
</span></span><span class=line><span class=cl>      h = func(code int, text string) error {
</span></span><span class=line><span class=cl>         message := FormatCloseMessage(code, &#34;&#34;)
</span></span><span class=line><span class=cl>         c.WriteControl(CloseMessage, message, time.Now().Add(writeWait))
</span></span><span class=line><span class=cl>         return nil
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   c.handleClose = h
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func (c *Conn) SetPingHandler(h func(appData string) error) {
</span></span><span class=line><span class=cl>   if h == nil {
</span></span><span class=line><span class=cl>      h = func(message string) error {
</span></span><span class=line><span class=cl>         err := c.WriteControl(PongMessage, []byte(message), time.Now().Add(writeWait))
</span></span><span class=line><span class=cl>         return err
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   c.handlePing = h
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func (c *Conn) SetPongHandler(h func(appData string) error) {
</span></span><span class=line><span class=cl>   if h == nil {
</span></span><span class=line><span class=cl>      h = func(string) error { return nil }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   c.handlePong = h
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=readmessage>ReadMessage</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (c *Conn) ReadMessage() (messageType int, p []byte, err error) {
</span></span><span class=line><span class=cl>   var r io.Reader
</span></span><span class=line><span class=cl>   messageType, r, err = c.NextReader()
</span></span><span class=line><span class=cl>   if err != nil {
</span></span><span class=line><span class=cl>      return messageType, nil, err
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   p, err = ioutil.ReadAll(r)
</span></span><span class=line><span class=cl>   return messageType, p, err
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func (c *Conn) NextReader() (messageType int, r io.Reader, err error) {
</span></span><span class=line><span class=cl>   for c.readErr == nil {
</span></span><span class=line><span class=cl>       frameType, err := c.advanceFrame()
</span></span><span class=line><span class=cl>       if err != nil {
</span></span><span class=line><span class=cl>          c.readErr = hideTempErr(err)
</span></span><span class=line><span class=cl>          break
</span></span><span class=line><span class=cl>       }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>       if frameType == TextMessage || frameType == BinaryMessage {
</span></span><span class=line><span class=cl>          c.messageReader = &amp;messageReader{c}
</span></span><span class=line><span class=cl>          c.reader = c.messageReader
</span></span><span class=line><span class=cl>          if c.readDecompress {
</span></span><span class=line><span class=cl>             c.reader = c.newDecompressionReader(c.reader)
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>          return frameType, c.reader, nil
</span></span><span class=line><span class=cl>       }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//解析数据帧
</span></span><span class=line><span class=cl>func (c *Conn) advanceFrame() (int, error) {
</span></span><span class=line><span class=cl>   p, err := c.read(2)
</span></span><span class=line><span class=cl>   final := p[0]&amp;finalBit != 0
</span></span><span class=line><span class=cl>   frameType := int(p[0] &amp; 0xf)
</span></span><span class=line><span class=cl>   mask := p[1]&amp;maskBit != 0
</span></span><span class=line><span class=cl>   c.setReadRemaining(int64(p[1] &amp; 0x7f))
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   switch frameType {
</span></span><span class=line><span class=cl>   case CloseMessage, PingMessage, PongMessage:
</span></span><span class=line><span class=cl>      if c.readRemaining &gt; maxControlFramePayloadSize {
</span></span><span class=line><span class=cl>         return noFrame, c.handleProtocolError(&#34;control frame length &gt; 125&#34;)
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      if !final {
</span></span><span class=line><span class=cl>         return noFrame, c.handleProtocolError(&#34;control frame not final&#34;)
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   case TextMessage, BinaryMessage:
</span></span><span class=line><span class=cl>      if !c.readFinal {
</span></span><span class=line><span class=cl>         return noFrame, c.handleProtocolError(&#34;message start before final message frame&#34;)
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      c.readFinal = final
</span></span><span class=line><span class=cl>   case continuationFrame:
</span></span><span class=line><span class=cl>      if c.readFinal {
</span></span><span class=line><span class=cl>         return noFrame, c.handleProtocolError(&#34;continuation after final message frame&#34;)
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      c.readFinal = final
</span></span><span class=line><span class=cl>   default:
</span></span><span class=line><span class=cl>      return noFrame, c.handleProtocolError(&#34;unknown opcode &#34; + strconv.Itoa(frameType))
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   switch c.readRemaining {
</span></span><span class=line><span class=cl>   case 126:
</span></span><span class=line><span class=cl>      p, err := c.read(2)
</span></span><span class=line><span class=cl>      if err := c.setReadRemaining(int64(binary.BigEndian.Uint16(p))); err != nil {
</span></span><span class=line><span class=cl>         return noFrame, err
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   case 127:
</span></span><span class=line><span class=cl>      p, err := c.read(8)
</span></span><span class=line><span class=cl>      if err != nil {
</span></span><span class=line><span class=cl>         return noFrame, err
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      if err := c.setReadRemaining(int64(binary.BigEndian.Uint64(p))); err != nil {
</span></span><span class=line><span class=cl>         return noFrame, err
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   if mask != c.isServer {
</span></span><span class=line><span class=cl>      return noFrame, c.handleProtocolError(&#34;incorrect mask flag&#34;)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   if mask {
</span></span><span class=line><span class=cl>      c.readMaskPos = 0
</span></span><span class=line><span class=cl>      p, err := c.read(len(c.readMaskKey))
</span></span><span class=line><span class=cl>      if err != nil {
</span></span><span class=line><span class=cl>         return noFrame, err
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      copy(c.readMaskKey[:], p)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   //处理控制帧
</span></span><span class=line><span class=cl>   switch frameType {
</span></span><span class=line><span class=cl>   case PongMessage:
</span></span><span class=line><span class=cl>      if err := c.handlePong(string(payload)); err != nil {
</span></span><span class=line><span class=cl>         return noFrame, err
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   case PingMessage:
</span></span><span class=line><span class=cl>      if err := c.handlePing(string(payload)); err != nil {
</span></span><span class=line><span class=cl>         return noFrame, err
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   case CloseMessage:
</span></span><span class=line><span class=cl>      closeCode := CloseNoStatusReceived
</span></span><span class=line><span class=cl>      closeText := &#34;&#34;
</span></span><span class=line><span class=cl>      if len(payload) &gt;= 2 {
</span></span><span class=line><span class=cl>         closeCode = int(binary.BigEndian.Uint16(payload))
</span></span><span class=line><span class=cl>         if !isValidReceivedCloseCode(closeCode) {
</span></span><span class=line><span class=cl>            return noFrame, c.handleProtocolError(&#34;invalid close code&#34;)
</span></span><span class=line><span class=cl>         }
</span></span><span class=line><span class=cl>         closeText = string(payload[2:])
</span></span><span class=line><span class=cl>         if !utf8.ValidString(closeText) {
</span></span><span class=line><span class=cl>            return noFrame, c.handleProtocolError(&#34;invalid utf8 payload in close frame&#34;)
</span></span><span class=line><span class=cl>         }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      if err := c.handleClose(closeCode, closeText); err != nil {
</span></span><span class=line><span class=cl>         return noFrame, err
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      return noFrame, &amp;CloseError{Code: closeCode, Text: closeText}
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   return frameType, nil
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=writemessage>WriteMessage</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (c *Conn) WriteMessage(messageType int, data []byte) error {
</span></span><span class=line><span class=cl>   var mw messageWriter
</span></span><span class=line><span class=cl>   // beginMessage prepares a connection and message writer for a new message.
</span></span><span class=line><span class=cl>    if err := c.beginMessage(&amp;mw, messageType); err != nil {
</span></span><span class=line><span class=cl>       return err
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    n := copy(c.writeBuf[mw.pos:], data)
</span></span><span class=line><span class=cl>    mw.pos += n
</span></span><span class=line><span class=cl>    data = data[n:]
</span></span><span class=line><span class=cl>    return mw.flushFrame(true, data)
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>//组装数据帧
</span></span><span class=line><span class=cl>func (w *messageWriter) flushFrame(final bool, extra []byte) error {
</span></span><span class=line><span class=cl>   c := w.c
</span></span><span class=line><span class=cl>   length := w.pos - maxFrameHeaderSize + len(extra)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   b0 := byte(w.frameType)
</span></span><span class=line><span class=cl>   if final {
</span></span><span class=line><span class=cl>      b0 |= finalBit
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   if w.compress {
</span></span><span class=line><span class=cl>      b0 |= rsv1Bit
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   w.compress = false
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   b1 := byte(0)
</span></span><span class=line><span class=cl>   if !c.isServer {
</span></span><span class=line><span class=cl>      b1 |= maskBit
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   // Assume that the frame starts at beginning of c.writeBuf.
</span></span><span class=line><span class=cl>   framePos := 0
</span></span><span class=line><span class=cl>   if c.isServer {
</span></span><span class=line><span class=cl>      // Adjust up if mask not included in the header.
</span></span><span class=line><span class=cl>      framePos = 4
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   switch {
</span></span><span class=line><span class=cl>   case length &gt;= 65536:
</span></span><span class=line><span class=cl>      c.writeBuf[framePos] = b0
</span></span><span class=line><span class=cl>      c.writeBuf[framePos+1] = b1 | 127
</span></span><span class=line><span class=cl>      binary.BigEndian.PutUint64(c.writeBuf[framePos+2:], uint64(length))
</span></span><span class=line><span class=cl>   case length &gt; 125:
</span></span><span class=line><span class=cl>      framePos += 6
</span></span><span class=line><span class=cl>      c.writeBuf[framePos] = b0
</span></span><span class=line><span class=cl>      c.writeBuf[framePos+1] = b1 | 126
</span></span><span class=line><span class=cl>      binary.BigEndian.PutUint16(c.writeBuf[framePos+2:], uint16(length))
</span></span><span class=line><span class=cl>   default:
</span></span><span class=line><span class=cl>      framePos += 8
</span></span><span class=line><span class=cl>      c.writeBuf[framePos] = b0
</span></span><span class=line><span class=cl>      c.writeBuf[framePos+1] = b1 | byte(length)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   if !c.isServer {
</span></span><span class=line><span class=cl>      key := newMaskKey()
</span></span><span class=line><span class=cl>      copy(c.writeBuf[maxFrameHeaderSize-4:], key[:])
</span></span><span class=line><span class=cl>      maskBytes(key, 0, c.writeBuf[maxFrameHeaderSize:w.pos])
</span></span><span class=line><span class=cl>      if len(extra) &gt; 0 {
</span></span><span class=line><span class=cl>         return w.endMessage(c.writeFatal(errors.New(&#34;websocket: internal error, extra used in client mode&#34;)))
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   // Write the buffers to the connection with best-effort detection of
</span></span><span class=line><span class=cl>   // concurrent writes. See the concurrency section in the package
</span></span><span class=line><span class=cl>   // documentation for more info.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   if c.isWriting {
</span></span><span class=line><span class=cl>      panic(&#34;concurrent write to websocket connection&#34;)
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>   c.isWriting = true
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   err := c.write(w.frameType, c.writeDeadline, c.writeBuf[framePos:w.pos], extra)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   ...
</span></span><span class=line><span class=cl>   return nil
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>Ref：</p><ul><li><a href=https://datatracker.ietf.org/doc/html/rfc6455# target=_blank rel="external nofollow noopener noreferrer">https://datatracker.ietf.org/doc/html/rfc6455#<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://zh.wikipedia.org/wiki/WebSocket target=_blank rel="external nofollow noopener noreferrer">https://zh.wikipedia.org/wiki/WebSocket<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=http://www.ruanyifeng.com/blog/2017/05/websocket.html target=_blank rel="external nofollow noopener noreferrer">http://www.ruanyifeng.com/blog/2017/05/websocket.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://pkg.go.dev/github.com/gorilla/websocket target=_blank rel="external nofollow noopener noreferrer">https://pkg.go.dev/github.com/gorilla/websocket<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li></ul></div><div class=post-reward><div class=comment>Buy me a coffee~</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward>赞赏</label><div class=reward-ways><div><img class=lazyload src=/svg/loading.min.svg data-src=/images/wechatpay.png data-srcset="/images/wechatpay.png, /images/wechatpay.png 1.5x, /images/wechatpay.png 2x" data-sizes=auto alt="chuxing 微信" title="chuxing 微信"><span data-animation>微信</span></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2022-12-10 14:35:38">更新于 2022-12-10&nbsp;<a class=git-hash href=https://github.com/xzygis/xzygis.github.io/commit/7f415305a8bfeea38ce6b8ff33483aeee48262b7 rel="external nofollow noopener noreferrer" target=_blank title="commit by eagle(crackcosmas@gmail.com) 7f415305a8bfeea38ce6b8ff33483aeee48262b7: 修改文章分类"><i class="fa-solid fa-hashtag fa-fw" aria-hidden=true></i>7f41530</a></span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/introduction-of-websocket/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href=https://github.com/xzygis/xzygis.github.io/edit/main/content/posts/2021/Introduction-of-websocket/index.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://xzygis.github.io/posts/introduction-of-websocket/ data-title=Websocket介绍 data-hashtags=websocket><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://xzygis.github.io/posts/introduction-of-websocket/ data-hashtag=websocket><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://xzygis.github.io/posts/introduction-of-websocket/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://xzygis.github.io/posts/introduction-of-websocket/ data-title=Websocket介绍 data-ralateuid=xzygis><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/websocket/ class=post-tag>websocket</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/manual-of-consul/ class=post-nav-item rel=prev title=Consul入门手册><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Consul入门手册</a>
<a href=/posts/three-ways-to-transfer-files-in-linux/ class=post-nav-item rel=next title=Linux文件传输的三种方式>Linux文件传输的三种方式<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/ rel="external nofollow noopener noreferrer">Valine</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18-RC"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2020 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/xzygis target=_blank rel="external nofollow noopener noreferrer">chuxing</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/xzygis/xzygis.github.io title="在 GitHub 上查看程式碼，訂閱請點 Watch" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:var(--fi-success);--bg-progress-dark:var(--fi-success-dark)></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/valine/Valine.min.js></script><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script src=/lib/lazysizes/lazysizes.min.js async defer></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=/lib/cell-watermark/watermark.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:50},comment:{enable:!0,expired:!1,valine:{appId:"FZOoctDsbsjlalvygCgbk2AK-gzGzoHsz",appKey:"1xmXqKigfmr7DhTcxfby7KL1",avatar:"wavatar",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!0,highlight:!0,lang:"zh-CN",meta:["nick","mail","link"],pageSize:10,placeholder:`ヾﾉ≧∀≦)o~ 有事请留言！
评论功能以邮件作为通知方式！
如有必要请填写正确邮箱哦！`,recordIP:!0,visitor:!0}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{algoliaAppID:"MTJNHU0JVB",algoliaIndex:"index",algoliaSearchKey:"5486225134d99f43826da401ee9bad57",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},twemoji:!0,watermark:{appendto:".wrapper\u003emain",colspacing:30,content:'\u003cimg style="height: 0.85rem;" src="/logo.png" alt="logo" /\u003e 楚兴',enable:!0,fontfamily:"MMT_LRH,沐目体",fontsize:1.1,height:20,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YPVLJZ991S",{anonymize_ip:!0})</script><script src="https://www.googletagmanager.com/gtag/js?id=G-YPVLJZ991S" async></script></body></html>