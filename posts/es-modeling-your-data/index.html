<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>ES数据建模之关联关系处理 - 楚兴 - Chuxing's Blog</title><meta name=author content>
<meta name=author-link content><meta name=description content='现实世界有很多重要的关联关系：博客帖子有一些评论，银行账户有多次交易记录，客户有多个银行账户，订单有多个订单明细，文件目录有多个文件和子目录。 内部对象数组 考虑包含内部对象的数组是如何被索引的。 假设我们有个 followers 数组： 1 2 3 4 5 6 7 { "followers": [ { "age": 35, "name": "Mary White"}, { "age": 26, "name": "Alex Jones"}, { "age": 19, "name": "Lisa Smith"} ] } 这个文档会像我们之前描述的那'><meta name=keywords content='ES'><meta itemprop=name content="ES数据建模之关联关系处理"><meta itemprop=description content='现实世界有很多重要的关联关系：博客帖子有一些评论，银行账户有多次交易记录，客户有多个银行账户，订单有多个订单明细，文件目录有多个文件和子目录。 内部对象数组 考虑包含内部对象的数组是如何被索引的。 假设我们有个 followers 数组： 1 2 3 4 5 6 7 { "followers": [ { "age": 35, "name": "Mary White"}, { "age": 26, "name": "Alex Jones"}, { "age": 19, "name": "Lisa Smith"} ] } 这个文档会像我们之前描述的那'><meta itemprop=datePublished content="2023-04-12T21:08:02+08:00"><meta itemprop=dateModified content="2023-04-12T21:12:24+08:00"><meta itemprop=wordCount content="1318"><meta itemprop=image content="https://xzygis.github.io/logo.png"><meta itemprop=keywords content="ES"><meta property="og:url" content="https://xzygis.github.io/posts/es-modeling-your-data/"><meta property="og:site_name" content="楚兴 - Chuxing's Blog"><meta property="og:title" content="ES数据建模之关联关系处理"><meta property="og:description" content='现实世界有很多重要的关联关系：博客帖子有一些评论，银行账户有多次交易记录，客户有多个银行账户，订单有多个订单明细，文件目录有多个文件和子目录。 内部对象数组 考虑包含内部对象的数组是如何被索引的。 假设我们有个 followers 数组： 1 2 3 4 5 6 7 { "followers": [ { "age": 35, "name": "Mary White"}, { "age": 26, "name": "Alex Jones"}, { "age": 19, "name": "Lisa Smith"} ] } 这个文档会像我们之前描述的那'><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-12T21:08:02+08:00"><meta property="article:modified_time" content="2023-04-12T21:12:24+08:00"><meta property="article:tag" content="ES"><meta property="og:image" content="https://xzygis.github.io/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://xzygis.github.io/logo.png"><meta name=twitter:title content="ES数据建模之关联关系处理"><meta name=twitter:description content='现实世界有很多重要的关联关系：博客帖子有一些评论，银行账户有多次交易记录，客户有多个银行账户，订单有多个订单明细，文件目录有多个文件和子目录。 内部对象数组 考虑包含内部对象的数组是如何被索引的。 假设我们有个 followers 数组： 1 2 3 4 5 6 7 { "followers": [ { "age": 35, "name": "Mary White"}, { "age": 26, "name": "Alex Jones"}, { "age": 19, "name": "Lisa Smith"} ] } 这个文档会像我们之前描述的那'><meta name=application-name content="技术洞察"><meta name=apple-mobile-web-app-title content="技术洞察"><meta name=theme-color data-light=#ffffff data-dark=#252627 content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://xzygis.github.io/posts/es-modeling-your-data/><link rel=prev href=https://xzygis.github.io/posts/introduction-to-redis-replication/><link rel=next href=https://xzygis.github.io/posts/key-leap-from-business-master-to-excellent-executive/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ES数据建模之关联关系处理","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/xzygis.github.io\/posts\/es-modeling-your-data\/"},"image":["https:\/\/xzygis.github.io\/site-meta.jpg"],"genre":"posts","keywords":"ES","wordcount":1318,"url":"https:\/\/xzygis.github.io\/posts\/es-modeling-your-data\/","datePublished":"2023-04-12T21:08:02+08:00","dateModified":"2023-04-12T21:12:24+08:00","publisher":{"@type":"Organization","name":"xzygis","logo":"https:\/\/xzygis.github.io\/images\/avatar.jpg"},"author":{"@type":"Person","name":"作者"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="楚兴 - Chuxing's Blog"><img loading=lazy src=/logo.png alt="楚兴 - Chuxing's Blog" data-title="楚兴 - Chuxing's Blog" width=26 height=26 class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>楚兴</span></a><span class=header-subtitle>知行合一</span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class=menu-item><a class=menu-link href=/about/ title=About>About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="楚兴 - Chuxing's Blog"><img loading=lazy src=/logo.png alt="楚兴 - Chuxing's Blog" data-title="楚兴 - Chuxing's Blog" width=26 height=26 class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>楚兴</span></a><span class=header-subtitle>知行合一</span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class=menu-item><a class=menu-link href=/about/ title=About>About</a></li><li class="menu-item text-center"><a class=menu-link href=https://github.com/xzygis/xzygis.github.io title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>ES数据建模之关联关系处理</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
Anonymous</span></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/storage/ class=post-category title="分类 - Storage"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Storage</a></span></div><div class=post-meta-line><span title="发布于 2023-04-12 21:08:02"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2023-04-12>2023-04-12</time></span>&nbsp;<span title="更新于 2023-04-12 21:12:24"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2023-04-12>2023-04-12</time></span>&nbsp;<span title="1318 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 1400 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 3 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=ES数据建模之关联关系处理>
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#内部对象数组>内部对象数组</a></li><li><a href=#嵌套对象>嵌套对象</a></li><li><a href=#父-子关系文档>父-子关系文档</a></li></ul></nav></div></div><div class=content id=content data-end-flag=(End)><p>现实世界有很多重要的关联关系：博客帖子有一些评论，银行账户有多次交易记录，客户有多个银行账户，订单有多个订单明细，文件目录有多个文件和子目录。</p><h2 id=内部对象数组 class=heading-element><span>内部对象数组</span>
<a href=#%e5%86%85%e9%83%a8%e5%af%b9%e8%b1%a1%e6%95%b0%e7%bb%84 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>考虑包含内部对象的数组是如何被索引的。 假设我们有个 followers 数组：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;followers&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nt>&#34;age&#34;</span><span class=p>:</span> <span class=mi>35</span><span class=p>,</span> <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Mary White&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nt>&#34;age&#34;</span><span class=p>:</span> <span class=mi>26</span><span class=p>,</span> <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Alex Jones&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nt>&#34;age&#34;</span><span class=p>:</span> <span class=mi>19</span><span class=p>,</span> <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Lisa Smith&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这个文档会像我们之前描述的那样被扁平化处理，结果如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;followers.age&#34;</span><span class=p>:</span>    <span class=p>[</span><span class=mi>19</span><span class=p>,</span> <span class=mi>26</span><span class=p>,</span> <span class=mi>35</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;followers.name&#34;</span><span class=p>:</span>   <span class=p>[</span><span class=err>alex</span><span class=p>,</span> <span class=err>jones</span><span class=p>,</span> <span class=err>lisa</span><span class=p>,</span> <span class=err>smith</span><span class=p>,</span> <span class=err>mary</span><span class=p>,</span> <span class=err>white</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>{age: 35}</code> 和 <code>{name: Mary White}</code> 之间的相关性已经丢失了，因为每个多值域只是一包无序的值，而不是有序数组。</p><h2 id=嵌套对象 class=heading-element><span>嵌套对象</span>
<a href=#%e5%b5%8c%e5%a5%97%e5%af%b9%e8%b1%a1 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>由于在 Elasticsearch 中单个文档的增删改都是原子性操作,那么将相关实体数据都存储在同一文档中也就理所当然。 比如说,我们可以将订单及其明细数据存储在一个文档中。又比如,我们可以将一篇博客文章的评论以一个 comments 数组的形式和博客文章放在一起：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>PUT</span> <span class=err>/my_index/blogpost/</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Nest eggs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;body&#34;</span><span class=p>:</span>  <span class=s2>&#34;Making your money work...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tags&#34;</span><span class=p>:</span>  <span class=p>[</span> <span class=s2>&#34;cash&#34;</span><span class=p>,</span> <span class=s2>&#34;shares&#34;</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments&#34;</span><span class=p>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span>    <span class=s2>&#34;John Smith&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;comment&#34;</span><span class=p>:</span> <span class=s2>&#34;Great article&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;age&#34;</span><span class=p>:</span>     <span class=mi>28</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;stars&#34;</span><span class=p>:</span>   <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;date&#34;</span><span class=p>:</span>    <span class=s2>&#34;2014-09-01&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span>    <span class=s2>&#34;Alice White&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;comment&#34;</span><span class=p>:</span> <span class=s2>&#34;More like this please&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;age&#34;</span><span class=p>:</span>     <span class=mi>31</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;stars&#34;</span><span class=p>:</span>   <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;date&#34;</span><span class=p>:</span>    <span class=s2>&#34;2014-10-22&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>如果我们依赖字段自动映射,那么 comments 字段会自动映射为 object 类型。</p><p>由于所有的信息都在一个文档中,当我们查询时就没有必要去联合文章和评论文档,查询效率就很高。但是因为JSON 格式的文档被处理成如下的扁平式键值对的结构，会导致查询结果不准确。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;title&#34;</span><span class=p>:</span>            <span class=p>[</span> <span class=err>eggs</span><span class=p>,</span> <span class=err>nest</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;body&#34;</span><span class=p>:</span>             <span class=p>[</span> <span class=err>making</span><span class=p>,</span> <span class=err>money</span><span class=p>,</span> <span class=err>work</span><span class=p>,</span> <span class=err>your</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tags&#34;</span><span class=p>:</span>             <span class=p>[</span> <span class=err>cash</span><span class=p>,</span> <span class=err>shares</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.name&#34;</span><span class=p>:</span>    <span class=p>[</span> <span class=err>alice</span><span class=p>,</span> <span class=err>john</span><span class=p>,</span> <span class=err>smith</span><span class=p>,</span> <span class=err>white</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.comment&#34;</span><span class=p>:</span> <span class=p>[</span> <span class=err>article</span><span class=p>,</span> <span class=err>great</span><span class=p>,</span> <span class=err>like</span><span class=p>,</span> <span class=err>more</span><span class=p>,</span> <span class=err>please</span><span class=p>,</span> <span class=err>this</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.age&#34;</span><span class=p>:</span>     <span class=p>[</span> <span class=mi>28</span><span class=p>,</span> <span class=mi>31</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.stars&#34;</span><span class=p>:</span>   <span class=p>[</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.date&#34;</span><span class=p>:</span>    <span class=p>[</span> <span class=mi>2014-09-01</span><span class=p>,</span> <span class=mi>2014-10-22</span> <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>嵌套对象 就是来解决这个问题的。将 comments 字段类型设置为 nested 而不是 object 后,每一个嵌套对象都会被索引为一个 隐藏的独立文档 ,举例如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.name&#34;</span><span class=p>:</span>    <span class=p>[</span> <span class=err>john</span><span class=p>,</span> <span class=err>smith</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.comment&#34;</span><span class=p>:</span> <span class=p>[</span> <span class=err>article</span><span class=p>,</span> <span class=err>great</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.age&#34;</span><span class=p>:</span>     <span class=p>[</span> <span class=mi>28</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.stars&#34;</span><span class=p>:</span>   <span class=p>[</span> <span class=mi>4</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.date&#34;</span><span class=p>:</span>    <span class=p>[</span> <span class=mi>2014-09-01</span> <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.name&#34;</span><span class=p>:</span>    <span class=p>[</span> <span class=err>alice</span><span class=p>,</span> <span class=err>white</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.comment&#34;</span><span class=p>:</span> <span class=p>[</span> <span class=err>like</span><span class=p>,</span> <span class=err>more</span><span class=p>,</span> <span class=err>please</span><span class=p>,</span> <span class=err>this</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.age&#34;</span><span class=p>:</span>     <span class=p>[</span> <span class=mi>31</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.stars&#34;</span><span class=p>:</span>   <span class=p>[</span> <span class=mi>5</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;comments.date&#34;</span><span class=p>:</span>    <span class=p>[</span> <span class=mi>2014-10-22</span> <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=nt>&#34;title&#34;</span><span class=p>:</span>            <span class=p>[</span> <span class=err>eggs</span><span class=p>,</span> <span class=err>nest</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;body&#34;</span><span class=p>:</span>             <span class=p>[</span> <span class=err>making</span><span class=p>,</span> <span class=err>money</span><span class=p>,</span> <span class=err>work</span><span class=p>,</span> <span class=err>your</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tags&#34;</span><span class=p>:</span>             <span class=p>[</span> <span class=err>cash</span><span class=p>,</span> <span class=err>shares</span> <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>第一个和第二个为嵌套文档，第三个为根文档。</p><p>在独立索引每一个嵌套对象后,对象中每个字段的相关性得以保留。我们查询时,也仅仅返回那些真正符合条件的文档。</p><p>不仅如此,由于嵌套文档直接存储在文档内部,查询时嵌套文档和根文档联合成本很低,速度和单独存储几乎一样。</p><p>嵌套文档是隐藏存储的,我们不能直接获取。如果要增删改一个嵌套对象,我们必须把整个文档重新索引才可以。值得注意的是,查询的时候返回的是整个文档,而不是嵌套文档本身。</p><h2 id=父-子关系文档 class=heading-element><span>父-子关系文档</span>
<a href=#%e7%88%b6-%e5%ad%90%e5%85%b3%e7%b3%bb%e6%96%87%e6%a1%a3 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>父-子关系文档 在实质上类似于 nested model（嵌套对象） ：允许将一个对象实体和另外一个对象实体关联起来。而这两种类型的主要区别是：在 nested objects 文档中，所有对象都是在同一个文档中，而在父-子关系文档中，父对象和子对象都是完全独立的文档。</p><p>父-子关系的主要作用是允许把一个 type 的文档和另外一个 type 的文档关联起来，构成一对多的关系：一个父文档可以对应多个子文档 。与 nested objects 相比，父-子关系的主要优势有：</p><ul><li><p>更新父文档时，不会重新索引子文档。</p></li><li><p>创建，修改或删除子文档时，不会影响父文档或其他子文档。这一点在这种场景下尤其有用：子文档数量较多，并且子文档创建和修改的频率高时。</p></li><li><p>子文档可以作为搜索结果独立返回。</p></li><li><p>Elasticsearch 维护了一个父文档和子文档的映射关系，得益于这个映射，父-子文档关联查询操作非常快。但是这个映射也对父-子文档关系有个限制条件：父文档和其所有子文档，都必须要存储在同一个分片中。</p></li></ul></div><div class=post-reward><div class=comment>Buy me a coffee~</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=static><div><img loading=lazy src=/images/wechatpay.png alt=微信 data-title=微信 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span data-animation>微信</span></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-04-12 21:12:24">更新于 2023-04-12&nbsp;</span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/es-modeling-your-data/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=twitter data-url=https://xzygis.github.io/posts/es-modeling-your-data/ data-title=ES数据建模之关联关系处理 data-hashtags=ES><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://xzygis.github.io/posts/es-modeling-your-data/ data-hashtag=ES><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://xzygis.github.io/posts/es-modeling-your-data/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://xzygis.github.io/posts/es-modeling-your-data/ data-title=ES数据建模之关联关系处理 data-ralateuid=xzygis><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/es/ class=post-tag title="标签 - ES">ES</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/introduction-to-redis-replication/ class=post-nav-item rel=prev title="Redis 复制"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Redis 复制</a>
<a href=/posts/key-leap-from-business-master-to-excellent-executive/ class=post-nav-item rel=next title=《关键跨越：从业务高手到优秀主管》：最大化团队产出>《关键跨越：从业务高手到优秀主管》：最大化团队产出<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.130.0"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.9"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2020 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><a href=https://github.com/xzygis/xzygis.github.io title="在 GitHub 上查看程式碼，訂閱請點 Watch" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:var(--fi-success);--bg-progress-dark:var(--fi-success-dark)></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=/lib/cell-watermark/watermark.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:50},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,pangu:{enable:!0,selector:"article"},search:{algoliaAppID:"MTJNHU0JVB",algoliaIndex:"index",algoliaSearchKey:"5486225134d99f43826da401ee9bad57",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},twemoji:!0,version:"v0.3.9",watermark:{appendto:".wrapper>main",colspacing:30,content:'<img style="height: 0.85rem;" src="/logo.png" alt="logo" /> 楚兴',enable:!0,fontfamily:"MMT_LRH,沐目体",fontsize:1.1,height:20,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YPVLJZ991S",{anonymize_ip:!0})</script><script src="https://www.googletagmanager.com/gtag/js?id=G-YPVLJZ991S" async></script></body></html>