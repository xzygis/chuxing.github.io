<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Redis AOF持久化 - Chu Xing</title><meta name=author content="chuxing"><meta name=author-link content="https://github.com/xzygis"><meta name=description content="除了RDB持久化功能1之外，Redis还提供了AOF（Append Only File）持久化功能。与RDB持久化通过保存数据库中的键值对来记录数据库状态不同，AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态的。 服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的"><meta name=keywords content="Redis"><meta itemprop=name content="Redis AOF持久化"><meta itemprop=description content="除了RDB持久化功能1之外，Redis还提供了AOF（Append Only File）持久化功能。与RDB持久化通过保存数据库中的键值对来记录数据库状态不同，AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态的。 服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的"><meta itemprop=datePublished content="2022-12-10T14:21:33+08:00"><meta itemprop=dateModified content="2022-12-10T15:13:57+08:00"><meta itemprop=wordCount content="4639"><meta itemprop=image content="https://xzygis.github.io/logo.png"><meta itemprop=keywords content="Redis,"><meta property="og:title" content="Redis AOF持久化"><meta property="og:description" content="除了RDB持久化功能1之外，Redis还提供了AOF（Append Only File）持久化功能。与RDB持久化通过保存数据库中的键值对来记录数据库状态不同，AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态的。 服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的"><meta property="og:type" content="article"><meta property="og:url" content="https://xzygis.github.io/posts/introduction-to-redis-aof-persistence/"><meta property="og:image" content="https://xzygis.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-10T14:21:33+08:00"><meta property="article:modified_time" content="2022-12-10T15:13:57+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://xzygis.github.io/logo.png"><meta name=twitter:title content="Redis AOF持久化"><meta name=twitter:description content="除了RDB持久化功能1之外，Redis还提供了AOF（Append Only File）持久化功能。与RDB持久化通过保存数据库中的键值对来记录数据库状态不同，AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态的。 服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的"><meta name=application-name content="Chu Xing"><meta name=apple-mobile-web-app-title content="Chu Xing"><meta name=theme-color data-light=#ffffff data-dark=#252627 content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://xzygis.github.io/posts/introduction-to-redis-aof-persistence/><link rel=prev href=https://xzygis.github.io/posts/introduction-to-redis-rdb-persistence/><link rel=next href=https://xzygis.github.io/posts/introduction-to-redis-client/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Redis AOF持久化","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/xzygis.github.io\/posts\/introduction-to-redis-aof-persistence\/"},"image":["https:\/\/xzygis.github.io\/site-meta.jpg"],"genre":"posts","keywords":"Redis","wordcount":4639,"url":"https:\/\/xzygis.github.io\/posts\/introduction-to-redis-aof-persistence\/","datePublished":"2022-12-10T14:21:33+08:00","dateModified":"2022-12-10T15:13:57+08:00","publisher":{"@type":"Organization","name":"xzygis","logo":"https:\/\/xzygis.github.io\/images\/avatar.jpg"},"author":{"@type":"Person","name":"chuxing"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="Chu Xing"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo.png data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x" data-sizes=auto alt="Chu Xing" title="Chu Xing"><span class=header-title-text>Chu Xing</span></a><span class=header-subtitle>楚兴的博客</span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class=menu-item><a class=menu-link href=/about/ title=About>About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Chu Xing"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo.png data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x" data-sizes=auto alt=/logo.png title=/logo.png><span class=header-title-text>Chu Xing</span></a><span class=header-subtitle>楚兴的博客</span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 所有文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class=menu-item><a class=menu-link href=/about/ title=About>About</a></li><li class="menu-item text-center"><a class=menu-link href=https://github.com/xzygis/xzygis.github.io title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container data-page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Redis AOF持久化</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/xzygis title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class="lazyload avatar" src=/svg/loading.min.svg data-src=/images/avatar.jpg data-srcset="/images/avatar.jpg, /images/avatar.jpg 1.5x, /images/avatar.jpg 2x" data-sizes=auto alt=chuxing title=chuxing>&nbsp;chuxing</a></span>
<span class=post-category>收录于 <a href=/categories/cache/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Cache</a></span></div><div class=post-meta-line><span title="2022-12-10 14:21:33"><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-12-10>2022-12-10</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden=true></i> 约 4639 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden=true></i> 预计阅读 10 分钟</span>&nbsp;<span id=/posts/introduction-to-redis-aof-persistence/ class="leancloud_visitors comment-visitors" data-flag-title="Redis AOF持久化">
<i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count>-</span>&nbsp;次阅读
</span>&nbsp;<span class=comment-count data-flag-title="Redis AOF持久化">
<i class="fa-regular fa-comments fa-fw" aria-hidden=true></i>&nbsp;<span data-xid=/posts/introduction-to-redis-aof-persistence/ class=valine-comment-count>-</span>&nbsp;条评论
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#aof持久化的实现2>AOF持久化的实现</a><ul><li><a href=#命令追加>命令追加</a></li><li><a href=#aof文件的写入与同步>AOF文件的写入与同步</a></li></ul></li><li><a href=#aof文件的载入与数据还原>AOF文件的载入与数据还原</a></li><li><a href=#aof重写>AOF重写</a><ul><li><a href=#aof文件重写的实现>AOF文件重写的实现</a></li><li><a href=#aof后台重写>AOF后台重写</a></li></ul></li><li><a href=#重点回顾>重点回顾</a></li></ul></nav></div></div><div class=content id=content data-end-flag=(End)><p>除了<a href=https://chuxing.club/posts/introduction-to-redis-rdb-persistence/ target=_blank rel="external nofollow noopener noreferrer">RDB持久化功能<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>之外，Redis还提供了AOF（Append Only File）持久化功能。与RDB持久化通过保存数据库中的键值对来记录数据库状态不同，AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态的。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/introduction-to-redis-aof-persistence/images/aof-persistence.png data-srcset="/posts/introduction-to-redis-aof-persistence/images/aof-persistence.png, /posts/introduction-to-redis-aof-persistence/images/aof-persistence.png 1.5x, /posts/introduction-to-redis-aof-persistence/images/aof-persistence.png 2x" data-sizes=auto alt=aof-persistence title=aof-persistence width=502 height=146></p><p>服务器在启动时，可以通过载入和执行AOF文件中保存的命令来还原服务器关闭之前的数据库状态。</p><h2 id=aof持久化的实现2>AOF持久化的实现<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></h2><p>AOF持久化功能的实现可以分为命令追加（append）、文件写入、文件同步（sync）三个步骤。</p><h3 id=命令追加>命令追加</h3><p>当AOF持久化功能处于打开状态时，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的aof_buf缓冲区的末尾：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>redisServer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// AOF缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sds</span> <span class=n>aof_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=aof文件的写入与同步>AOF文件的写入与同步</h3><p>Redis的服务器进程就是一个事件循环（loop），这个循环中的文件事件负责接收客户端的命令请求，以及向客户端发送命令回复，而时间事件则负责执行像serverCron函数这样需要定时运行的函数。</p><p>因为服务器在处理文件事件时可能会执行写命令，使得一些内容被追加到aof_buf缓冲区里面，所以在服务器每次结束一个事件循环之前，它都会调用flushAppendOnlyFile函数，考虑是否需要将aof_buf缓冲区中的内容写入和保存到AOF文件里面，这个过程可以用以下伪代码表示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>eventLoop</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>#处理文件事件，接收命令请求以及发送命令回复</span>
</span></span><span class=line><span class=cl>        <span class=c1>#处理命令请求时可能会有新内容被追加到 aof_buf缓冲区中</span>
</span></span><span class=line><span class=cl>        <span class=n>processFileEvents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>#处理时间事件</span>
</span></span><span class=line><span class=cl>        <span class=n>processTimeEvents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>#考虑是否要将 aof_buf中的内容写入和保存到 AOF文件里面</span>
</span></span><span class=line><span class=cl>        <span class=n>flushAppendOnlyFile</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p><code>flushAppendOnlyFile</code>函数的行为由服务器配置的<code>appendfsync</code>选项的值来决定，各个不同值产生的行为如下图所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/introduction-to-redis-aof-persistence/images/appendfsync-option.png data-srcset="/posts/introduction-to-redis-aof-persistence/images/appendfsync-option.png, /posts/introduction-to-redis-aof-persistence/images/appendfsync-option.png 1.5x, /posts/introduction-to-redis-aof-persistence/images/appendfsync-option.png 2x" data-sizes=auto alt=appendfsync title=appendfsync width=1152 height=324></p><p>如果用户没有主动为appendfsync选项设置值，那么appendfsync选项的默认值为everysec。</p><blockquote><p><strong>文件的写入和同步</strong></p><p>为了提高文件的写入效率，在现代操作系统中，当用户调用write函数，将一些数据写入到文件的时候，操作系统通常会将写入数据暂时保存在一个内存缓冲区里面，等到缓冲区的空间被填满、或者超过了指定的时限之后，才真正地将缓冲区中的数据写入到磁盘里面。</p><p>这种做法虽然提高了效率，但也为写入数据带来了安全问题，因为如果计算机发生停机，那么保存在内存缓冲区里面的写入数据将会丢失。</p><p>为此，系统提供了fsync和fdatasync两个同步函数，它们可以强制让操作系统立即将缓冲区中的数据写入到硬盘里面，从而确保写入数据的安全性。</p></blockquote><p>服务器配置appendfsync选项的值直接决定AOF持久化功能的效率和安全性。</p><ul><li>当appendfsync的值为always时，服务器在每个事件循环都要将aof_buf缓冲区中的所有内容写入到AOF文件，并且同步AOF文件，所以always的效率是appendfsync选项三个值当中<strong>最慢</strong>的一个，但从安全性来说，always也是最安全的，因为即使出现故障停机，AOF持久化也只会丢失一个事件循环中所产生的命令数据。</li><li>当appendfsync的值为everysec时，服务器在每个事件循环都要将aof_buf缓冲区中的所有内容写入到AOF文件，并且每隔一秒就要在子线程中对AOF文件进行一次同步。<strong>从效率上来讲，everysec模式足够快，并且就算出现故障停机，数据库也只丢失一秒钟的命令数据</strong>。</li><li>当appendfsync的值为no时，服务器在每个事件循环都要将aof_buf缓冲区中的所有内容写入到AOF文件，至于何时对AOF文件进行同步，则由操作系统控制。因为处于no模式下的flushAppendOnlyFile调用无须执行同步操作，所以该模式下的AOF文件写入速度总是<strong>最快</strong>的，不过因为这种模式会在系统缓存中积累一段时间的写入数据，所以该模式的单次同步时长通常是三种模式中时间最长的。从平摊操作的角度来看，no模式和everysec模式的效率类似，当出现故障停机时，使用no模式的服务器将丢失上次同步AOF文件之后的所有写命令数据。</li></ul><h2 id=aof文件的载入与数据还原>AOF文件的载入与数据还原</h2><p>Redis读取AOF文件并还原数据库状态的详细步骤如下：</p><ol><li>创建一个不带网络连接的伪客户端（fake client）：因为Redis的命令只能在客户端上下文中执行，而载入AOF文件时所使用的命令直接来源于AOF文件而不是网络连接，所以服务器使用了一个没有网络连接的伪客户端来执行AOF文件保存的写命令，伪客户端执行命令的效果和带网络连接的客户端执行命令的效果完全一样。</li><li>从AOF文件中分析并读取出一条写命令。</li><li>使用伪客户端执行被读出的写命令。</li><li>一直执行步骤2和步骤3，直到AOF文件中的所有写命令都被处理完毕为止。</li></ol><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/introduction-to-redis-aof-persistence/images/aof-load-procedure.png data-srcset="/posts/introduction-to-redis-aof-persistence/images/aof-load-procedure.png, /posts/introduction-to-redis-aof-persistence/images/aof-load-procedure.png 1.5x, /posts/introduction-to-redis-aof-persistence/images/aof-load-procedure.png 2x" data-sizes=auto alt=aof-load-procedure title=aof-load-procedure width=547 height=435></p><h2 id=aof重写>AOF重写</h2><p>因为AOF持久化是通过保存被执行的写命令来记录数据库状态的，所以随着服务器运行时间的流逝，AOF文件中的内容会越来越多，文件的体积也会越来越大，如果不加以控制的话，体积过大的AOF文件很可能对Redis服务器、甚至整个宿主计算机造成影响，并且AOF文件的体积越大，使用AOF文件来进行数据还原所需的时间就越多。</p><p>为了解决AOF文件体积膨胀的问题，Redis提供了AOF文件重写（rewrite）功能。通过该功能，Redis服务器可以创建一个新的AOF文件来替代现有的AOF文件，新旧两个AOF文件所保存的数据库状态相同，但新AOF文件不会包含任何浪费空间的冗余命令，所以新AOF文件的体积通常会比旧AOF文件的体积要小得多。</p><h3 id=aof文件重写的实现>AOF文件重写的实现</h3><p>虽然Redis将生成新AOF文件替换旧AOF文件的功能命名为“AOF文件重写”，但实际上，AOF文件重写并不需要对现有的AOF文件进行任何读取、分析或者写入操作，这个功能是通过读取服务器当前的数据库状态来实现的。</p><p>整个重写过程可以用以下伪代码表示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>aof_rewrite</span><span class=p>(</span><span class=n>new_aof_file_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1>#创建新 AOF文件</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=n>create_file</span><span class=p>(</span><span class=n>new_aof_file_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#遍历数据库</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>db</span> <span class=ow>in</span> <span class=n>redisServer</span><span class=o>.</span><span class=n>db</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>#忽略空数据库</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>db</span><span class=o>.</span><span class=n>is_empty</span><span class=p>():</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=c1>#写入SELECT命令，指定数据库号码</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write_command</span><span class=p>(</span><span class=s2>&#34;SELECT&#34;</span> <span class=o>+</span> <span class=n>db</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#遍历数据库中的所有键</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>db</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>#忽略已过期的键</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>key</span><span class=o>.</span><span class=n>is_expired</span><span class=p>():</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=c1>#根据键的类型对键进行重写</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>key</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=n>String</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rewrite_string</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>key</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=n>List</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rewrite_list</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>key</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=n>Hash</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rewrite_hash</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>key</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=n>Set</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rewrite_set</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>key</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=n>SortedSet</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>rewrite_sorted_set</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>#如果键带有过期时间，那么过期时间也要被重写</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>key</span><span class=o>.</span><span class=n>have_expire_time</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>rewrite_expire_time</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#写入完毕，关闭文件</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rewrite_string</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用GET命令获取字符串键的值</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=n>GET</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用SET命令重写字符串键</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write_command</span><span class=p>(</span><span class=n>SET</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rewrite_list</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用LRANGE命令获取列表键包含的所有元素</span>
</span></span><span class=line><span class=cl>        <span class=n>item1</span><span class=p>,</span> <span class=n>item2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>itemN</span> <span class=o>=</span> <span class=n>LRANGE</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用RPUSH命令重写列表键</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write_command</span><span class=p>(</span><span class=n>RPUSH</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>item1</span><span class=p>,</span> <span class=n>item2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>itemN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rewrite_hash</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用HGETALL命令获取哈希键包含的所有键值对</span>
</span></span><span class=line><span class=cl>        <span class=n>field1</span><span class=p>,</span> <span class=n>value1</span><span class=p>,</span> <span class=n>field2</span><span class=p>,</span> <span class=n>value2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>fieldN</span><span class=p>,</span> <span class=n>valueN</span> <span class=o>=</span> <span class=n>HGETALL</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用HMSET命令重写哈希键</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write_command</span><span class=p>(</span><span class=n>HMSET</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>field1</span><span class=p>,</span> <span class=n>value1</span><span class=p>,</span> <span class=n>field2</span><span class=p>,</span> <span class=n>value2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>fieldN</span><span class=p>,</span> <span class=n>valueN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rewrite_set</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用SMEMBERS命令获取集合键包含的所有元素</span>
</span></span><span class=line><span class=cl>        <span class=n>elem1</span><span class=p>,</span> <span class=n>elem2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>elemN</span> <span class=o>=</span> <span class=n>SMEMBERS</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用SADD命令重写集合键</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write_command</span><span class=p>(</span><span class=n>SADD</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>elem1</span><span class=p>,</span> <span class=n>elem2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>elemN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rewrite_sorted_set</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用ZRANGE命令获取有序集合键包含的所有元素</span>
</span></span><span class=line><span class=cl>        <span class=n>member1</span><span class=p>,</span> <span class=n>score1</span><span class=p>,</span> <span class=n>member2</span><span class=p>,</span> <span class=n>score2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>memberN</span><span class=p>,</span> <span class=n>scoreN</span> <span class=o>=</span> <span class=n>ZRANGE</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;WITHSCORES&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用ZADD命令重写有序集合键</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write_command</span><span class=p>(</span><span class=n>ZADD</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>score1</span><span class=p>,</span> <span class=n>member1</span><span class=p>,</span> <span class=n>score2</span><span class=p>,</span> <span class=n>member2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>scoreN</span><span class=p>,</span> <span class=n>memberN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rewrite_expire_time</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1>#获取毫秒精度的键过期时间戳</span>
</span></span><span class=line><span class=cl>        <span class=n>timestamp</span> <span class=o>=</span> <span class=n>get_expire_time_in_unixstamp</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#使用PEXPIREAT命令重写键的过期时间</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write_command</span><span class=p>(</span><span class=n>PEXPIREAT</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>在实际中，为了避免在执行命令时造成客户端输入缓冲区溢出，重写程序在处理列表、哈希表、集合、有序集合这四种可能会带有多个元素的键时，会先检查键所包含的元素数量，如果元素的数量超过了redis.h/REDIS_AOF_REWRITE_ITEMS_PER_CMD常量的值，那么重写程序将使用多条命令来记录键的值，而不单单使用一条命令。</p><h3 id=aof后台重写>AOF后台重写</h3><p>AOF重写程序aof_rewrite函数可以很好地完成创建一个新AOF文件的任务，但是，因为这个函数会进行大量的写入操作，所以调用这个函数的线程将被长时间阻塞，因为Redis服务器使用单个线程来处理命令请求，所以如果由服务器直接调用aof_rewrite函数的话，那么在重写AOF文件期间，服务期将无法处理客户端发来的命令请求。</p><p>作为一种辅佐性的维护手段，Redis不希望AOF重写造成服务器无法处理请求，所以Redis决定将AOF重写程序放到子进程里执行，这样做可以同时达到两个目的：</p><ul><li>子进程进行AOF重写期间，服务器进程（父进程）可以继续处理命令请求。</li><li>子进程带有服务器进程的数据副本，使用子进程而不是线程，可以在避免使用锁的情况下，保证数据的安全性。</li></ul><p>不过，使用子进程也有一个问题需要解决，因为子进程在进行AOF重写期间，服务器进程还需要继续处理命令请求，而新的命令可能会对现有的数据库状态进行修改，从而使得服务器当前的数据库状态和重写后的AOF文件所保存的数据库状态不一致。</p><p>为了解决这种数据不一致问题，Redis服务器设置了一个AOF重写缓冲区，这个缓冲区在服务器创建子进程之后开始使用，当Redis服务器执行完一个写命令之后，它会同时将这个写命令发送给AOF缓冲区和AOF重写缓冲区。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/introduction-to-redis-aof-persistence/images/aof-rewrite-buf.png data-srcset="/posts/introduction-to-redis-aof-persistence/images/aof-rewrite-buf.png, /posts/introduction-to-redis-aof-persistence/images/aof-rewrite-buf.png 1.5x, /posts/introduction-to-redis-aof-persistence/images/aof-rewrite-buf.png 2x" data-sizes=auto alt=aof-rewrite-buf title=aof-rewrite-buf width=515 height=211></p><p>在子进程执行AOF重写期间，服务器进程需要执行以下三个工作：</p><ol><li>执行客户端发来的命令。</li><li>将执行后的写命令追加到AOF缓冲区。</li><li>将执行后的写命令追加到AOF重写缓冲区。</li></ol><p>这样一来可以保证：</p><ul><li>AOF缓冲区的内容会定期被写入和同步到AOF文件，对现有AOF文件的处理工作会如常进行。</li><li>从创建子进程开始，服务器执行的所有写命令都会被记录到AOF重写缓冲区里面。</li></ul><p>当子进程完成AOF重写工作之后，它会向父进程发送一个信号，父进程在接到该信号之后，会调用一个信号处理函数，并执行以下工作：</p><ol><li>将AOF重写缓冲区中的所有内容写入到新AOF文件中，这时新AOF文件所保存的数据库状态将和服务器当前的数据库状态一致。</li><li>对新的AOF文件进行改名，原子地（atomic）覆盖现有的AOF文件，完成新旧两个AOF文件的替换。</li></ol><p>这个信号处理函数执行完毕之后，父进程就可以继续像往常一样接受命令请求了。</p><p>在整个AOF后台重写过程中，只有信号处理函数执行时会对服务器进程（父进程）造成阻塞，在其他时候，AOF后台重写都不会阻塞父进程，这将AOF重写对服务器性能造成的影响降到了最低。</p><h2 id=重点回顾>重点回顾</h2><ul><li>AOF文件通过保存所有修改数据库的写命令请求来记录服务器的数据库状态。</li><li>AOF文件中的所有命令都以Redis命令请求协议的格式保存。</li><li>命令请求会先保存到AOF缓冲区里面，之后再定期写入并同步到AOF文件。</li><li>appendfsync选项的不同值对AOF持久化功能的安全性以及Redis服务器的性能有很大的影响。</li><li>服务器只要载入并重新执行保存在AOF文件中的命令，就可以还原数据库本来的状态。</li><li>AOF重写可以产生一个新的AOF文件，这个新的AOF文件和原有的AOF文件所保存的数据库状态一样，但体积更小。</li><li>AOF重写是一个有歧义的名字，该功能是通过读取数据库中的键值对来实现的，程序无须对现有AOF文件进行任何读入、分析或者写入操作。</li><li>在执行BGREWRITEAOF命令时，Redis服务器会维护一个AOF重写缓冲区，该缓冲区会在子进程创建新AOF文件期间，记录服务器执行的所有写命令。当子进程完成创建新AOF文件的工作之后，服务器会将重写缓冲区中的所有内容追加到新AOF文件的末尾，使得新旧两个AOF文件所保存的数据库状态一致。最后，服务器用新的AOF文件替换旧的AOF文件，以此来完成AOF文件重写操作。</li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://chuxing.club/posts/introduction-to-redis-rdb-persistence/ target=_blank rel="external nofollow noopener noreferrer">Redis RDB持久化<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>《Redis设计与实现》&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=post-reward><div class=comment>Buy me a coffee~</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward>赞赏</label><div class=reward-ways><div><img src=/images/wechatpay.png alt="chuxing 微信">
<span data-animation>微信</span></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2022-12-10 15:13:57">更新于 2022-12-10&nbsp;<a class=git-hash href=https://github.com/xzygis/xzygis.github.io/commit/3a547a704e24498bea61fecc1ae77f28aeea79ff rel="external nofollow noopener noreferrer" target=_blank title="commit by eagle(crackcosmas@gmail.com) 3a547a704e24498bea61fecc1ae77f28aeea79ff: 增加文章：Redis AOF持久化"><i class="fa-solid fa-hashtag fa-fw" aria-hidden=true></i>3a547a7</a></span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/introduction-to-redis-aof-persistence/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href=https://github.com/xzygis/xzygis.github.io/edit/main/content/posts/2022/Introduction-to-Redis-AOF-Persistence/index.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://xzygis.github.io/posts/introduction-to-redis-aof-persistence/ data-title="Redis AOF持久化" data-hashtags=Redis><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://xzygis.github.io/posts/introduction-to-redis-aof-persistence/ data-hashtag=Redis><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://xzygis.github.io/posts/introduction-to-redis-aof-persistence/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://xzygis.github.io/posts/introduction-to-redis-aof-persistence/ data-title="Redis AOF持久化" data-ralateuid=xzygis><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/redis/ class=post-tag>Redis</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/introduction-to-redis-rdb-persistence/ class=post-nav-item rel=prev title="Redis RDB持久化"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Redis RDB持久化</a>
<a href=/posts/introduction-to-redis-client/ class=post-nav-item rel=next title="Redis 客户端">Redis 客户端<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/ rel="external nofollow noopener noreferrer">Valine</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.109.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.17-RC"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2020 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/xzygis target=_blank rel="external nofollow noopener noreferrer">chuxing</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/xzygis/xzygis.github.io title="在 GitHub 上查看程式碼，訂閱請點 Watch" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:var(--fi-success);--bg-progress-dark:var(--fi-success-dark)></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/valine/Valine.min.js></script><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script src=/lib/lazysizes/lazysizes.min.js async defer></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script src=/lib/cell-watermark/watermark.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:50},comment:{enable:!0,expired:!1,valine:{appId:"FZOoctDsbsjlalvygCgbk2AK-gzGzoHsz",appKey:"1xmXqKigfmr7DhTcxfby7KL1",avatar:"wavatar",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!0,highlight:!0,lang:"zh-CN",meta:["nick","mail","link"],pageSize:10,placeholder:`ヾﾉ≧∀≦)o~ 有事请留言！
评论功能以邮件作为通知方式！
如有必要请填写正确邮箱哦！`,recordIP:!0,visitor:!0}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{algoliaAppID:"MTJNHU0JVB",algoliaIndex:"index",algoliaSearchKey:"5486225134d99f43826da401ee9bad57",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},twemoji:!0,watermark:{appendto:".wrapper\u003emain",colspacing:30,content:'\u003cimg style="height: 0.85rem;" src="/logo.png" alt="logo" /\u003e 楚兴',enable:!0,fontfamily:"MMT_LRH,沐目体",fontsize:1.1,height:20,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YPVLJZ991S",{anonymize_ip:!0})</script><script src="https://www.googletagmanager.com/gtag/js?id=G-YPVLJZ991S" async></script></body></html>